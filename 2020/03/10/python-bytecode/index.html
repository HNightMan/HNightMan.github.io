
<!DOCTYPE html>
<html lang="" class="loading">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Python字节码 - Theorist</title>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="google" content="notranslate" />
    <meta name="keywords" content="Theorist,"> 
    <meta name="description" content="Theorist&#39;s Blog,寒假的时候做hgame2020，借week2两道python逆向题，整理一下有关python字节码的一些东西。
pyc文件简介学过Python的都知道.py结尾的是Python的源码文件，.pyc是,"> 
    <meta name="author" content="Theorist"> 
    <link rel="alternative" href="atom.xml" title="Theorist" type="application/atom+xml"> 
    <link rel="icon" href="https://s2.ax1x.com/2019/07/10/Z6aCSs.png"> 
    
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">

    
<link rel="stylesheet" href="/css/diaspora.css">

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
         (adsbygoogle = window.adsbygoogle || []).push({
              google_ad_client: "ca-pub-8691406134231910",
              enable_page_level_ads: true
         });
    </script>
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
<meta name="generator" content="Hexo 5.4.0"></head>

<body class="loading">
    <span id="config-title" style="display:none">Theorist</span>
    <div id="loader"></div>
    <div id="single">
    <div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <a class="iconfont icon-home image-icon" href="javascript:;" data-url="https://theorist.fun"></a>
    <div title="播放/暂停" class="iconfont icon-play"></div>
    <h3 class="subtitle">Python字节码</h3>
    <div class="social">
        <div>
            <div class="share">
                <a title="获取二维码" class="iconfont icon-scan" href="javascript:;"></a>
            </div>
            <div id="qr"></div>
        </div>
    </div>
    <div class="scrollbar"></div>
</div>

    <div class="section">
        <div class="article">
    <div class='main'>
        <h1 class="title">Python字节码</h1>
        <div class="stuff">
            <span>三月 10, 2020</span>
            
  <ul class="post-tags-list" itemprop="keywords"><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/Python/" rel="tag">Python</a></li><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/%E7%AC%94%E8%AE%B0/" rel="tag">笔记</a></li></ul>


        </div>
        <div class="content markdown">
            <p>寒假的时候做hgame2020，借week2两道python逆向题，整理一下有关python字节码的一些东西。</p>
<h1 id="pyc文件简介"><a href="#pyc文件简介" class="headerlink" title="pyc文件简介"></a>pyc文件简介</h1><p>学过Python的都知道<code>.py</code>结尾的是Python的源码文件，<code>.pyc</code>是源码编译后生成的字节码文件，也可以运行，明明可以直接运行源码文件，这个字节码文件有什么卵用？</p>
<p>一来是为了无源文件发行，可以隐藏源码；还有就是编译后的<code>.pyc</code>文件比源码文件要快，有人说运行的时候会更快，但官方文档是这样写的：</p>
<blockquote>
<p>A program doesn’t run any faster when it is read from a <code>.pyc</code> file than when it is read from a <code>.py</code> file; the only thing that’s faster about <code>.pyc</code> files is the speed with which they are loaded.</p>
</blockquote>
<p>字节码文件运行并不会比源码文件快，主要是加载(被import)比源码文件快。</p>
<h1 id="代码对象"><a href="#代码对象" class="headerlink" title="代码对象"></a>代码对象</h1><p>先介绍一下代码对象，代码对象是 CPython 实现的低级细节。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">func</span>():</span></span><br><span class="line"><span class="meta">... </span>    print(<span class="string">&#x27;hello&#x27;</span>)</span><br><span class="line">...</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>func.__code__</span><br><span class="line">&lt;code object func at <span class="number">0x0000015797EA3780</span>, file <span class="string">&quot;&lt;stdin&gt;&quot;</span>, line <span class="number">1</span>&gt;</span><br></pre></td></tr></table></figure>

<p>这个东西就是代码对象，表示可执行Python代码或者字节码，在示例中表示函数中的代码部分，不包含对全局变量的引用和函数默认参数等其他东西(示例函数中也没有)。</p>
<p>代码对象中还有一大堆属性：</p>
<ul>
<li><p><code>co_name</code>是函数名称。</p>
</li>
<li><p><code>co_argcount</code>是位置参数的数量，包括仅限位置参数和具有默认值的参数。</p>
</li>
<li><p><code>co_kwonlyargcount</code>为仅限位置参数的数量 (包括带有默认值的参数)  Python3中有，Python2中没有</p>
</li>
<li><p><code>co_nlocals</code>是函数使用的局部变量数，包括参数。</p>
</li>
<li><p><code>co_varnames</code>是一个包含局部变量名称的元组，以参数名称开头。</p>
</li>
<li><p><code>co_cellvars</code>是一个元组，包含嵌套函数引用的局部变量的名称。</p>
</li>
<li><p><code>co_freevars</code>是一个包含自由变量名称的的元组。</p>
</li>
<li><p><code>co_code</code>是表示字节码指令序列的二进制数据。</p>
</li>
<li><p><code>co_consts</code>是一个包含字节码使用的字面值的元组。如果代码对象表示函数，则co_consts的第一项是函数的文档字符串，如果文档字符串未定义，则是None。</p>
</li>
<li><p><code>co_names</code>是一个包含字节码使用的名称的元组(不包括变量名)。</p>
</li>
<li><p><code>co_filename</code>是编译代码的文件名。</p>
</li>
<li><p><code>co_firstlineno</code>是函数的第一个行号。</p>
</li>
<li><p><code>co_lnotab</code>是一个字符串，用于编码从字节码偏移到行号的映射（更详细的信息参考解释的源代码）。</p>
</li>
<li><p><code>co_stacksize</code>是所需的堆栈大小（包括局部变量）。</p>
</li>
<li><p><code>co_flags</code> 为一个整数，其中编码了解释器所用的多个旗标。以下是可用于 <code>co_flags</code> 的标志位定义：如果函数使用 <code>*arguments</code> 语法来接受任意数量的位置参数，则 <code>0x04</code> 位被设置；如果函数使用 <code>**keywords</code> 语法来接受任意数量的关键字参数，则 <code>0x08</code> 位被设置；如果函数是一个生成器，则 <code>0x20</code> 位被设置。</p>
<p>代码对象跟分析字节码有啥关系呢？我们可以用一个dis模块把代码对象编程人类可读的字节码。</p>
</li>
</ul>
<h1 id="dis模块-—-Python-字节码反汇编器"><a href="#dis模块-—-Python-字节码反汇编器" class="headerlink" title="dis模块 — Python 字节码反汇编器"></a>dis模块 — Python 字节码反汇编器</h1><p>dis模块通过反汇编支持CPython的字节码分析。</p>
<p>这里只从官方文档以用两个常用的函数介绍，其他具体请看<a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/library/dis.html">官方文档</a>：</p>
<ul>
<li><p><code>dis.``dis</code>(<em>x=None</em>, ***, <em>file=None</em>, <em>depth=None</em>)</p>
<p>反汇编 <em>x</em> 对象。 <em>x</em> 可以表示模块、类、方法、函数、生成器、异步生成器、协程、代码对象、源代码字符串或原始字节码的字节序列（划重点）。对于模块，它会反汇编所有功能。对于一个类，它反汇编所有方法（包括类和静态方法）。对于代码对象或原始字节码序列，它每字节码指令打印一行。它还递归地反汇编嵌套代码对象（推导式代码，生成器表达式和嵌套函数，以及用于构建嵌套类的代码）。在被反汇编之前，首先使用 <a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/library/functions.html#compile"><code>compile()</code></a> 内置函数将字符串编译为代码对象。如果未提供任何对象，则此函数会反汇编最后一次回溯。如果提供的话，反汇编将作为文本写入提供的 <em>file</em> 参数，否则写入 <code>sys.stdout</code> 。递归的最大深度受 <em>depth</em> 限制，除非它是 <code>None</code> 。 <code>depth=0</code> 表示没有递归。<em>在 3.4 版更改:</em> 添加 <em>file</em> 形参。<em>在 3.7 版更改:</em> 实现了递归反汇编并添加了 <em>depth</em> 参数。<em>在 3.7 版更改:</em> 现在可以处理协程和异步生成器对象。</p>
</li>
<li><p><code>dis.``distb</code>(<em>tb=None</em>, ***, <em>file=None</em>)</p>
<p>如果没有传递，则使用最后一个回溯来反汇编回溯的堆栈顶部函数。 指示了导致异常的指令。如果提供的话，反汇编将作为文本写入提供的 <em>file</em> 参数，否则写入 <code>sys.stdout</code> 。<em>在 3.4 版更改:</em> 添加 <em>file</em> 形参。</p>
<p>生成人类可读字节码示例如下：</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> dis</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">f</span>():</span></span><br><span class="line"><span class="meta">... </span>    print(<span class="string">&#x27;hello&#x27;</span>)</span><br><span class="line">...</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>dis.dis(f)</span><br><span class="line">  <span class="number">2</span>           <span class="number">0</span> LOAD_GLOBAL              <span class="number">0</span> (<span class="keyword">print</span>)</span><br><span class="line">              <span class="number">2</span> LOAD_CONST               <span class="number">1</span> (<span class="string">&#x27;hello&#x27;</span>)</span><br><span class="line">              <span class="number">4</span> CALL_FUNCTION            <span class="number">1</span></span><br><span class="line">              <span class="number">6</span> POP_TOP</span><br><span class="line">              <span class="number">8</span> LOAD_CONST               <span class="number">0</span> (<span class="literal">None</span>)</span><br><span class="line">             <span class="number">10</span> RETURN_VALUE</span><br></pre></td></tr></table></figure>

<p>为啥要把源码搞成更难读的字节码？这其实不是我们的主要目的，因为源码一般是不会直接给我们的，dis模块也可以反汇编<code>.pyc</code>文件中原始字节码的字节序列（上面函数介绍中我有划重点）。</p>
<h1 id="marshal模块-—-内部-Python-对象序列化"><a href="#marshal模块-—-内部-Python-对象序列化" class="headerlink" title="marshal模块 — 内部 Python 对象序列化"></a>marshal模块 — 内部 Python 对象序列化</h1><p>此模块包含一此能以二进制格式来读写Python值的函数。</p>
<p>Warning：The marshal module is not intended to be secure against erroneous or maliciously constructed data. Never unmarshal data received from an untrusted or unauthenticated source.</p>
<p>也只从官方引用两个常用的函数介绍，其他细节见<a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/library/marshal.html">官方文档</a>:</p>
<ul>
<li><p><code>marshal.``dump</code>(<em>value</em>, <em>file</em>[, <em>version</em>])</p>
<p>向打开的文件写入值。 值必须为受支持的类型。 文件必须为可写的 <a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/glossary.html#term-binary-file">binary file</a>。如果值具有（或所包含的对象具有）不受支持的类型，则会引发 <a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/library/exceptions.html#ValueError"><code>ValueError</code></a> — 但是将向文件写入垃圾数据。 对象也将不能正确地通过 <a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/library/marshal.html#marshal.load"><code>load()</code></a> 重新读取。<em>version</em> 参数指明 <code>dump</code> 应当使用的数据格式（见下文）。</p>
</li>
<li><p><code>marshal.``load</code>(<em>file</em>)</p>
<p>从打开的文件读取一个值并返回。 如果读不到有效的值（例如由于数据为不同 Python 版本的不兼容 marshal 格式），则会引发 <a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/library/exceptions.html#EOFError"><code>EOFError</code></a>, <a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/library/exceptions.html#ValueError"><code>ValueError</code></a> 或 <a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/library/exceptions.html#TypeError"><code>TypeError</code></a>。 文件必须为可读的 <a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/glossary.html#term-binary-file">binary file</a>。注解 如果通过 <a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/library/marshal.html#marshal.dump"><code>dump()</code></a> marshal 了一个包含不受支持类型的对象，<a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/library/marshal.html#marshal.load"><code>load()</code></a> 将为不可 marshal 的类型替换 <code>None</code>。</p>
</li>
</ul>
<p>简单来说marshal对于我们逆向python最大的作用就是可以从<code>.pyc</code>文件中读取Python对象，然后就可以用dis反汇编成人类可读的字节码来分析。</p>
<p>然后新的问题又来了，我们怎么从<code>.pyc</code>文件中找到代码对象的位置呢？</p>
<h1 id="pyc文件分析"><a href="#pyc文件分析" class="headerlink" title="pyc文件分析"></a>pyc文件分析</h1><p>根据不同的Python版本<code>.pyc</code>文件的格式也会有所变化，。</p>
<h2 id="Python2-7"><a href="#Python2-7" class="headerlink" title="Python2.7"></a>Python2.7</h2><p>我们先随便写一个py文件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">s=<span class="string">&#x27;ssss&#x27;</span></span><br><span class="line">i=<span class="number">666</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f</span>():</span></span><br><span class="line">	s=<span class="string">&#x27;ss&#x27;</span></span><br><span class="line">	i=<span class="number">66</span></span><br><span class="line">	print(<span class="string">&#x27;hello&#x27;</span>)</span><br><span class="line"></span><br><span class="line">f()</span><br></pre></td></tr></table></figure>

<p><code>python -m test.py</code>编译生成<code>.pyc</code>文件</p>
<p>十六进制打开：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;Challenges# hexdump -C test.pyc</span><br><span class="line">00000000  03 f3 0d 0a d4 c0 22 5e  63 00 00 00 00 00 00 00  |......&quot;^c.......|</span><br><span class="line">00000010  00 01 00 00 00 40 00 00  00 73 20 00 00 00 64 00  |.....@...s ...d.|</span><br><span class="line">00000020  00 5a 00 00 64 01 00 5a  01 00 64 02 00 84 00 00  |.Z..d..Z..d.....|</span><br><span class="line">00000030  5a 02 00 65 02 00 83 00  00 01 64 03 00 53 28 04  |Z..e......d..S(.|</span><br><span class="line">00000040  00 00 00 74 04 00 00 00  73 73 73 73 69 9a 02 00  |...t....ssssi...|</span><br><span class="line">00000050  00 63 00 00 00 00 02 00  00 00 01 00 00 00 43 00  |.c............C.|</span><br><span class="line">00000060  00 00 73 15 00 00 00 64  01 00 7d 00 00 64 02 00  |..s....d..&#125;..d..|</span><br><span class="line">00000070  7d 01 00 64 03 00 47 48  64 00 00 53 28 04 00 00  |&#125;..d..GHd..S(...|</span><br><span class="line">00000080  00 4e 74 02 00 00 00 73  73 69 42 00 00 00 74 05  |.Nt....ssiB...t.|</span><br><span class="line">00000090  00 00 00 68 65 6c 6c 6f  28 00 00 00 00 28 02 00  |...hello(....(..|</span><br><span class="line">000000a0  00 00 74 01 00 00 00 73  74 01 00 00 00 69 28 00  |..t....st....i(.|</span><br><span class="line">000000b0  00 00 00 28 00 00 00 00  73 07 00 00 00 74 65 73  |...(....s....tes|</span><br><span class="line">000000c0  74 2e 70 79 74 01 00 00  00 66 04 00 00 00 73 06  |t.pyt....f....s.|</span><br><span class="line">000000d0  00 00 00 00 01 06 01 06  01 4e 28 03 00 00 00 52  |.........N(....R|</span><br><span class="line">000000e0  03 00 00 00 52 04 00 00  00 52 05 00 00 00 28 00  |....R....R....(.|</span><br><span class="line">000000f0  00 00 00 28 00 00 00 00  28 00 00 00 00 73 07 00  |...(....(....s..|</span><br><span class="line">00000100  00 00 74 65 73 74 2e 70  79 74 08 00 00 00 3c 6d  |..test.pyt....&lt;m|</span><br><span class="line">00000110  6f 64 75 6c 65 3e 01 00  00 00 73 06 00 00 00 06  |odule&gt;....s.....|</span><br><span class="line">00000120  01 06 02 09 05                                    |.....|</span><br><span class="line">00000125</span><br></pre></td></tr></table></figure>

<p>这些密密麻麻的数据分别代表什么意思，先按顺序列一个表，再详细讲解：</p>
<table>
<thead>
<tr>
<th align="center">字段</th>
<th align="center">长度（默认最低长度）</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">MagicNumber</td>
<td align="center">4字节</td>
<td align="center">魔数，区别不同版本的Python字节码</td>
</tr>
<tr>
<td align="center">时间戳</td>
<td align="center">4字节</td>
<td align="center">最后修改时间</td>
</tr>
<tr>
<td align="center">TYPE_CODE</td>
<td align="center">1字节</td>
<td align="center">这里是’c’，表示接下来是一个CodeObject，见<a target="_blank" rel="noopener" href="https://github.com/python/cpython/blob/master/Python/marshal.c">Cpython源码</a></td>
</tr>
<tr>
<td align="center">co_argcount</td>
<td align="center">4字节</td>
<td align="center">后面一堆属性上面代码对象都有讲，我就不重复写了</td>
</tr>
<tr>
<td align="center">co_nlocals</td>
<td align="center">4字节</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">co_stacksize</td>
<td align="center">4字节</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">co_flags</td>
<td align="center">4字节</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">TYPE_STRING</td>
<td align="center">byte</td>
<td align="center">这里是’s’，表示接下来是一个string，也就是co_code</td>
</tr>
<tr>
<td align="center">co_code size</td>
<td align="center">4字节</td>
<td align="center">co_code的长度，这里是0x20(小端序)</td>
</tr>
<tr>
<td align="center">co_code value</td>
<td align="center">根据上面的size确定字节数</td>
<td align="center">co_code的值</td>
</tr>
<tr>
<td align="center">TYPE_TUPLE</td>
<td align="center">1字节</td>
<td align="center">这里是’(‘，表示接下来是一个元组，也就是co_consts</td>
</tr>
<tr>
<td align="center">co_consts size</td>
<td align="center">4字节</td>
<td align="center">这里是4，表示co_consts的元组中4个值，接下来就挨个表示这些值</td>
</tr>
<tr>
<td align="center">co_consts[0] TYPE</td>
<td align="center">1字节</td>
<td align="center">这里是’t’，表示co_consts[0]是一个int</td>
</tr>
<tr>
<td align="center">co_const[0] value</td>
<td align="center">4字节</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">co_consts[1] TYPE</td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">co_consts[1] size</td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">co_consts[1] value</td>
<td align="center"></td>
<td align="center"></td>
</tr>
</tbody></table>
<p><code>co_consts</code>结束后是<code>co_names</code>,<code>co_varnames</code>,<code>co_freevars</code>,<code>co_cellvars</code>结构与<code>co_consts</code>相同，需要提一下如果元组中的数据类型是整形就不需要再标明长度，默认是4字节。</p>
<p>上面几个属性结束之后是<code>co_filename</code>在示例中偏移为<code>0xfd</code>处（因为前几个属性长度不同，此字段位置不确定），在这里是<code>&#39;s&#39;</code>,表示<code>TYPE_STRING</code>，然后是长度为7，然后是文件名<code>test.py</code>；之后是<code>co_name</code>,<code>co_firstlineno</code>,<code>co_lnotab</code>。</p>
<p>还有实例中偏移<code>0x51</code>的位置又有一个<code>&#39;c&#39;</code>，是因为CodeObject中的<code>co_consts</code>中有另一个CodeObject，也就是源码中的<code>f()</code>函数，之后会递归分析<code>f()</code>函数，然后再返回继续分析上层CodeObject剩下的内容，方法一样。</p>
<p>总结在<code>.pyc</code>文件中对象的储存方式就是  <strong>类型表示 长度 值</strong>  这样的格式。</p>
<h2 id="Python3-7"><a href="#Python3-7" class="headerlink" title="Python3.7"></a>Python3.7</h2><p>还是先整个示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;Challenges&#x2F;__pycache__# hexdump -C test.cpython-37.pyc </span><br><span class="line">00000000  42 0d 0d 0a 00 00 00 00  d4 c0 22 5e 3c 00 00 00  |B.........&quot;^&lt;...|</span><br><span class="line">00000010  e3 00 00 00 00 00 00 00  00 00 00 00 00 02 00 00  |................|</span><br><span class="line">00000020  00 40 00 00 00 73 1a 00  00 00 64 00 5a 00 64 01  |.@...s....d.Z.d.|</span><br><span class="line">00000030  5a 01 64 02 64 03 84 00  5a 02 65 02 83 00 01 00  |Z.d.d...Z.e.....|</span><br><span class="line">00000040  64 04 53 00 29 05 5a 04  73 73 73 73 69 9a 02 00  |d.S.).Z.ssssi...|</span><br><span class="line">00000050  00 63 00 00 00 00 00 00  00 00 02 00 00 00 02 00  |.c..............|</span><br><span class="line">00000060  00 00 43 00 00 00 73 14  00 00 00 64 01 7d 00 64  |..C...s....d.&#125;.d|</span><br><span class="line">00000070  02 7d 01 74 00 64 03 83  01 01 00 64 00 53 00 29  |.&#125;.t.d.....d.S.)|</span><br><span class="line">00000080  04 4e 5a 02 73 73 e9 42  00 00 00 5a 05 68 65 6c  |.NZ.ss.B...Z.hel|</span><br><span class="line">00000090  6c 6f 29 01 da 05 70 72  69 6e 74 29 02 da 01 73  |lo)...print)...s|</span><br><span class="line">000000a0  da 01 69 a9 00 72 05 00  00 00 fa 18 2f 72 6f 6f  |..i..r......&#x2F;roo|</span><br><span class="line">000000b0  74 2f 43 68 61 6c 6c 65  6e 67 65 73 2f 74 65 73  |t&#x2F;Challenges&#x2F;tes|</span><br><span class="line">000000c0  74 2e 70 79 da 01 66 04  00 00 00 73 06 00 00 00  |t.py..f....s....|</span><br><span class="line">000000d0  00 01 04 01 04 01 72 07  00 00 00 4e 29 03 72 03  |......r....N).r.|</span><br><span class="line">000000e0  00 00 00 72 04 00 00 00  72 07 00 00 00 72 05 00  |...r....r....r..|</span><br><span class="line">000000f0  00 00 72 05 00 00 00 72  05 00 00 00 72 06 00 00  |..r....r....r...|</span><br><span class="line">00000100  00 da 08 3c 6d 6f 64 75  6c 65 3e 01 00 00 00 73  |...&lt;module&gt;....s|</span><br><span class="line">00000110  06 00 00 00 04 01 04 02  08 05                    |..........|</span><br><span class="line">0000011a</span><br></pre></td></tr></table></figure>



<p>Python3.7开始<code>.pyc</code>的文件头有4个32-bit words，第一个word还是魔数，如果第二个是0，那么第三个就是时间戳，第四个是文件大小，如果第二个word的最低为设置为1，那么该<code>.pyc</code>文件就是一个基于哈希的字节码文件，后两个words就是一个64-bit的哈希值。示例中第二个word就为0。具体细节看<a target="_blank" rel="noopener" href="https://www.python.org/dev/peps/pep-0552/#specification">官方文档</a>。</p>
<p>之后就是CodeObject，3.7<code>.pyc</code>中的CodeObject开头是一个<code>0xe3</code>，表示接下来就是CodeObject(2.7中这里是<code>&#39;c&#39;</code>)，之后接着是五个32-bit的word，依次是<code>co_argcount</code>,<code>co_kwonlyargcount</code>,<code>co_nlocals</code>,<code>co_stacksize</code>,<code>co_flags</code>，比Python2.7多一个<code>co_kwonlyargcount</code>，示例中在偏移为<code>0x15</code>的位置。</p>
<p>然后<code>&#39;s&#39;</code>是类型标识，表示接下来是co_code(代码段)，然后是长度，在示例中是<code>0x1a</code>。</p>
<p>代码段之后 是<code>co_consts</code>等，格式与2.7版本基本大同小异。</p>
<p>总结一些我发现的两个版本不同的地方（可能并不完全）：</p>
<ol>
<li>Python3.7版本文件头是4个32-bit word，2.7是两个；</li>
<li>Pyhon3.7版本在<code>co_argcount</code>字段后面多了一个<code>co_kwonlyargcount</code>字段，长度为4bytes；</li>
<li>Python3.7中主函数的CodeObject开始的标识是<code>0xe3</code>,内层CodeObject开始标识是<code>&#39;c&#39;</code>，2.7全是<code>&#39;c&#39;</code>；</li>
<li>Python3.7中元组的类型标识是<code>&#39;)&#39;</code>,2.7中是<code>&#39;(&#39;</code>；</li>
<li>Python3.7中字符串的类型标识为<code>&#39;Z&#39;</code>，2.7是<code>&#39;s&#39;</code>;</li>
<li>Python3.7中元组和字符串等的的size字段默认最少是1byte，2.7中是4byte。</li>
</ol>
<p>还是找到CodeObject的位置用dis和marshal分析，整个样例:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; import dis,marshal</span><br><span class="line">&gt;&gt;&gt; f&#x3D;open(&#39;Pyc.pyc&#39;,&#39;rb&#39;)</span><br><span class="line">&gt;&gt;&gt; f.read(16)</span><br><span class="line">b&#39;B\r\r\n\x00\x00\x00\x00\xdaR%^ \x04\x00\x00&#39;</span><br><span class="line">&gt;&gt;&gt; code&#x3D;marshal.load(f)</span><br><span class="line">&gt;&gt;&gt; dis.dis(code)</span><br><span class="line">  3           0 JUMP_ABSOLUTE            2</span><br><span class="line">        &gt;&gt;    2 LOAD_CONST               0 (0)</span><br><span class="line">              4 LOAD_CONST               1 (None)</span><br><span class="line">              6 IMPORT_NAME              0 (os)</span><br><span class="line">              8 STORE_NAME               0 (os)</span><br><span class="line">             10 LOAD_CONST               0 (0)</span><br><span class="line">             .......</span><br></pre></td></tr></table></figure>

<p>至此，我们基本可以把可读字节码给搞出来了，然后我们来看怎么读。</p>
<h1 id="Python字节码说明"><a href="#Python字节码说明" class="headerlink" title="Python字节码说明"></a>Python字节码说明</h1><p>还是先整一个样例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> dis</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">f</span>():</span></span><br><span class="line"><span class="meta">... </span>    print(<span class="string">&#x27;hello world&#x27;</span>)</span><br><span class="line">...</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>dis.dis(f)</span><br><span class="line">  <span class="number">2</span>           <span class="number">0</span> LOAD_GLOBAL              <span class="number">0</span> (<span class="keyword">print</span>)</span><br><span class="line">              <span class="number">2</span> LOAD_CONST               <span class="number">1</span> (<span class="string">&#x27;hello world&#x27;</span>)</span><br><span class="line">              <span class="number">4</span> CALL_FUNCTION            <span class="number">1</span></span><br><span class="line">              <span class="number">6</span> POP_TOP</span><br><span class="line">              <span class="number">8</span> LOAD_CONST               <span class="number">0</span> (<span class="literal">None</span>)</span><br><span class="line">             <span class="number">10</span> RETURN_VALUE</span><br></pre></td></tr></table></figure>

<p>反汇编出来的可读字节码有5列：</p>
<p>第一列： 示例中的“2”，在源代码中的行数；</p>
<p>第二列： 语句在co_code中的偏移；</p>
<p>第三列： opcode，操作码，在示例中被换成了对应的opname，方便阅读，opcode与opname的对应可以在python的opcode模块中查看也可以查看<a target="_blank" rel="noopener" href="https://github.com/python/cpython/blob/master/Lib/opcode.py">官方源码</a>；</p>
<p>第四列： 操作数，有的opcode没有操作数；</p>
<p>第五列： 操作数的实际值（自动注释）；</p>
<p>在3.6版本中修改：每条指令使用2字节，以前根据指令的不同长度也不同，上面示例是3.7版本的，可以看出每一句的偏移+2。</p>
<p>Python字节码是完全面向栈的，没有寄存器什么的。</p>
<p>用TOS表示栈顶值，TOS1表示栈顶下1个地址的值，TOS2表示栈顶下2个地址的值……</p>
<p>各opname对应的具体操作见<a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3.8/library/dis.html">dis官方文档</a></p>
<p>这里解释一下第五列的实际数值和第四列的操作数有什么关系，如果操作数是一个字面值(比如opname为<code>LOAD_CONST</code>)，那么之前说了，CodeObject中有一个<code>co_consts</code>是一个储存了所有字面值的元组，那第四列的操作数就是该字面值在元组中的下标(从0开始)，局部变量，全局变量等同理，不过反正第五列会自动注释出来的，也不用自己去查；如果操作数没有在这些元组里，比如示例中的<code>CALL_FUNCTION  1</code>,表示以TOS为参数调用TOS1的函数，就没有第五列。</p>
<h1 id="Python字节码混淆"><a href="#Python字节码混淆" class="headerlink" title="Python字节码混淆"></a>Python字节码混淆</h1><p>没有经过任何处理的<code>.pyc</code>文件可以直接用在线工具或者uncompyle6反编译出<code>.py</code>源码，也可以用marshal和dis反汇编出可读字节码，对大佬来说可读字节码就和源码一样。我们可以在编译好的<code>.pyc</code>文件上加一些东西来阻止uncompyle6和dis等工具的逆向。(下面的例子只是例子，可以自己灵活处理，也可以搭配食用)</p>
<h2 id="加跳转-可对抗uncompyle6"><a href="#加跳转-可对抗uncompyle6" class="headerlink" title="加跳转(可对抗uncompyle6)"></a>加跳转(可对抗uncompyle6)</h2><p>在代码段(co_code)开头的位置加一个跳转跳到第二句(原本的第一句)，提一下无条件跳转的opcode是<code>0x71</code>,但是要注意版本，因为2.7版本中这条指令是3字节长度，3.7中是2字节长度。</p>
<p>所以2.7版本加三个字节<code>0x71 0x03 0x00</code>,记得改前面的co_code_size字段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1           0 JUMP_ABSOLUTE            3</span><br><span class="line">      &gt;&gt;    3 LOAD_CONST               0 (&#39;helloworld&#39;)</span><br><span class="line">            6 PRINT_ITEM</span><br><span class="line">            7 PRINT_NEWLINE</span><br><span class="line">            8 LOAD_CONST               1 (None)</span><br><span class="line">           11 RETURN_VALUE</span><br></pre></td></tr></table></figure>

<p>3.7版本加两个字节<code>0x71 0x02</code>，记得改前面的co_code_size字段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">1           0 JUMP_ABSOLUTE            2</span><br><span class="line">      &gt;&gt;    2 LOAD_CONST               0 (1099511627775)</span><br><span class="line"></span><br><span class="line">2           4 STORE_NAME               0 (a)</span><br><span class="line">            6 LOAD_CONST               1 (&#39;0&#39;)</span><br><span class="line">            8 LOAD_CONST               0 (1099511627775)</span><br><span class="line">           10 BINARY_MULTIPLY</span><br><span class="line">           12 STORE_NAME               1 (s)</span><br><span class="line">           14 LOAD_CONST               2 (None)</span><br><span class="line">           16 RETURN_VALUE</span><br></pre></td></tr></table></figure>

<p>很明显这个跳转是无意义的，但加了之后uncompyle6就无法直接反编译出源码，但可以反编译出不完整的可读字节码。</p>
<p>这种方法混淆的字节码还是可以用marshal和dis来分析。</p>
<h2 id="加跳转和错误语句-可对抗dis和uncompyle6"><a href="#加跳转和错误语句-可对抗dis和uncompyle6" class="headerlink" title="加跳转和错误语句(可对抗dis和uncompyle6)"></a>加跳转和错误语句(可对抗dis和uncompyle6)</h2><p>在字节码中手动加入错误的语句,再加个跳转跳过这条错误语句，因为dis分析的时候不会跳转，而程序运行会跳转，这样就可以阻止dis反汇编出可读字节码。错误语句可以压栈一个很大的操作数，超出元组的下标就会报错。</p>
<p>还是要注意版本。</p>
<p>2.7加<code>0x71 0x06 0x00 0x64 0xff 0xff</code>,记得改前面的co_code_size字段，然后dis分析就会添加的错误语句处报错，无法反汇编后面的代码。</p>
<p>3.7加<code>0x71 0x04 0x64 0xff</code>，改长度。</p>
<p>3.7版本的示例手动还原后是这样的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1           0 JUMP_ABSOLUTE            4</span><br><span class="line">       	 2 LOAD_COMST				256</span><br><span class="line">4      &gt;&gt;   4 LOAD_CONST               0 (1099511627775)</span><br><span class="line"></span><br><span class="line">            6  STORE_NAME               0 (a)</span><br><span class="line">            8  LOAD_CONST               1 (&#39;0&#39;)</span><br><span class="line">            10 LOAD_CONST               0 (1099511627775)</span><br><span class="line">            12 BINARY_MULTIPLY</span><br><span class="line">            14 STORE_NAME               1 (s)</span><br><span class="line">            16 LOAD_CONST               2 (None)</span><br><span class="line">            18 RETURN_VALUE</span><br></pre></td></tr></table></figure>

<p>可以看出程序运行时错误指令会被跳过。</p>
<h2 id="重叠指令-可以对抗dis和uncompyle6"><a href="#重叠指令-可以对抗dis和uncompyle6" class="headerlink" title="重叠指令(可以对抗dis和uncompyle6)"></a>重叠指令(可以对抗dis和uncompyle6)</h2><p>嫖的2.7版本例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0 JUMP_ABSOLUTE        [71 05 00]     5 </span><br><span class="line">3 PRINT_ITEM           [47 -- --]</span><br><span class="line">4 LOAD_CONST           [64 64 01]     356</span><br><span class="line">7 STOP_CODE            [00 -- --]</span><br></pre></td></tr></table></figure>

<p>第一句绝对跳转到第三局指令的操作数的位置，但是第三个指令的操作数也是一个opcode，所以跳转过来后执行的指令其实是<code>0x64 0x01 0x00</code> (LOAD_CONST  1)。</p>
<p>Python3.6以后每条指令都是2字节好像就不大好进行这种操作了，我自己测试的时候2.7成功了3.7失败了，可能是我太菜…</p>
<h2 id="私有指令集"><a href="#私有指令集" class="headerlink" title="私有指令集"></a>私有指令集</h2><p>在opcode.h文件中修改opcode与opname的匹配，修改后编译生成的pyc文件只有与其拥有相同指令集的目标才能运行，无法用于发行。</p>
<h1 id="Python字节码反混淆"><a href="#Python字节码反混淆" class="headerlink" title="Python字节码反混淆"></a>Python字节码反混淆</h1><p>针对上面的加跳转和错误指令的混淆方法，会产生下标越界而报错，可以修改dis模块的源码在去值前先判断是否越界，如果越界则跳过，自己整了个3.7的例子：</p>
<p>源码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> op <span class="keyword">in</span> hasconst:</span><br><span class="line">             argval, argrepr = _get_const_info(arg, constants)</span><br><span class="line">         <span class="keyword">elif</span> op <span class="keyword">in</span> hasname:</span><br><span class="line">             argval, argrepr = _get_name_info(arg, names)</span><br><span class="line">         <span class="keyword">elif</span> op <span class="keyword">in</span> hasjrel:</span><br><span class="line">             argval = offset + <span class="number">2</span> + arg</span><br><span class="line">             argrepr = <span class="string">&quot;to &quot;</span> + repr(argval)</span><br><span class="line">         <span class="keyword">elif</span> op <span class="keyword">in</span> haslocal:</span><br><span class="line">             argval, argrepr = _get_name_info(arg, varnames)</span><br><span class="line">         <span class="keyword">elif</span> op <span class="keyword">in</span> hascompare:</span><br><span class="line">             argval = cmp_op[arg]</span><br><span class="line">             argrepr = argval</span><br><span class="line">         <span class="keyword">elif</span> op <span class="keyword">in</span> hasfree:</span><br><span class="line">             argval, argrepr = _get_name_info(arg, cells)</span><br><span class="line">         <span class="keyword">elif</span> op == FORMAT_VALUE:</span><br><span class="line">             argval = ((<span class="literal">None</span>, str, repr, ascii)[arg &amp; <span class="number">0x3</span>], bool(arg &amp; <span class="number">0x4</span>))</span><br><span class="line">             argrepr = (<span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;str&#x27;</span>, <span class="string">&#x27;repr&#x27;</span>, <span class="string">&#x27;ascii&#x27;</span>)[arg &amp; <span class="number">0x3</span>]</span><br><span class="line">             <span class="keyword">if</span> argval[<span class="number">1</span>]:</span><br><span class="line">                 <span class="keyword">if</span> argrepr:</span><br><span class="line">                     argrepr += <span class="string">&#x27;, &#x27;</span></span><br><span class="line">                 argrepr += <span class="string">&#x27;with format&#x27;</span></span><br></pre></td></tr></table></figure>

<p>修改后：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> op <span class="keyword">in</span> hasconst <span class="keyword">and</span> arg &lt; len(constants):</span><br><span class="line">             argval, argrepr = _get_const_info(arg, constants)</span><br><span class="line">         <span class="keyword">elif</span> op <span class="keyword">in</span> hasname <span class="keyword">and</span> arg &lt; len(names):</span><br><span class="line">             argval, argrepr = _get_name_info(arg, names)</span><br><span class="line">         <span class="keyword">elif</span> op <span class="keyword">in</span> hasjrel:</span><br><span class="line">             argval = offset + <span class="number">2</span> + arg</span><br><span class="line">             argrepr = <span class="string">&quot;to &quot;</span> + repr(argval)</span><br><span class="line">         <span class="keyword">elif</span> op <span class="keyword">in</span> haslocal <span class="keyword">and</span> arg &lt; len(varnames):</span><br><span class="line">             argval, argrepr = _get_name_info(arg, varnames)</span><br><span class="line">         <span class="keyword">elif</span> op <span class="keyword">in</span> hascompare:</span><br><span class="line">             argval = cmp_op[arg]</span><br><span class="line">             argrepr = argval</span><br><span class="line">         <span class="keyword">elif</span> op <span class="keyword">in</span> hasfree <span class="keyword">and</span> arg &lt; len(cells):</span><br><span class="line">             argval, argrepr = _get_name_info(arg, cells)</span><br><span class="line">         <span class="keyword">elif</span> op == FORMAT_VALUE:</span><br><span class="line">             argval = ((<span class="literal">None</span>, str, repr, ascii)[arg &amp; <span class="number">0x3</span>], bool(arg &amp; <span class="number">0x4</span>))</span><br><span class="line">             argrepr = (<span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;str&#x27;</span>, <span class="string">&#x27;repr&#x27;</span>, <span class="string">&#x27;ascii&#x27;</span>)[arg &amp; <span class="number">0x3</span>]</span><br><span class="line">             <span class="keyword">if</span> argval[<span class="number">1</span>]:</span><br><span class="line">                 <span class="keyword">if</span> argrepr:</span><br><span class="line">                     argrepr += <span class="string">&#x27;, &#x27;</span></span><br><span class="line">                 argrepr += <span class="string">&#x27;with format&#x27;</span></span><br></pre></td></tr></table></figure>

<p>2.7版本也可。</p>
<p>之后就可以用dis反汇编出这种混淆的字节码。</p>
<h1 id="题解"><a href="#题解" class="headerlink" title="题解"></a>题解</h1><h2 id="babypy"><a href="#babypy" class="headerlink" title="babypy"></a>babypy</h2><p>最后言归正传，hgame2020 week2 的两个python题。</p>
<p>第一个打开文件得到：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">In [1]: from secret import flag, encrypt</span><br><span class="line"></span><br><span class="line">In [2]: encrypt(flag)</span><br><span class="line">Out[2]: &#39;7d037d045717722d62114e6a5b044f2c184c3f44214c2d4a22&#39;</span><br><span class="line"></span><br><span class="line">In [3]: import dis</span><br><span class="line"></span><br><span class="line">In [4]: dis.dis(encrypt)</span><br><span class="line">  4           0 LOAD_FAST                0 (OOo)</span><br><span class="line">              2 LOAD_CONST               0 (None)</span><br><span class="line">              4 LOAD_CONST               0 (None)</span><br><span class="line">              6 LOAD_CONST               1 (-1)</span><br><span class="line">              8 BUILD_SLICE              3</span><br><span class="line">             10 BINARY_SUBSCR</span><br><span class="line">             12 STORE_FAST               1 (O0O)</span><br><span class="line"></span><br><span class="line">  5          14 LOAD_GLOBAL              0 (list)</span><br><span class="line">             16 LOAD_FAST                1 (O0O)</span><br><span class="line">             18 CALL_FUNCTION            1</span><br><span class="line">             20 STORE_FAST               2 (O0o)</span><br><span class="line"></span><br><span class="line">  6          22 SETUP_LOOP              50 (to 74)</span><br><span class="line">             24 LOAD_GLOBAL              1 (range)</span><br><span class="line">             26 LOAD_CONST               2 (1)</span><br><span class="line">             28 LOAD_GLOBAL              2 (len)</span><br><span class="line">             30 LOAD_FAST                2 (O0o)</span><br><span class="line">             32 CALL_FUNCTION            1</span><br><span class="line">             34 CALL_FUNCTION            2</span><br><span class="line">             36 GET_ITER</span><br><span class="line">        &gt;&gt;   38 FOR_ITER                32 (to 72)</span><br><span class="line">             40 STORE_FAST               3 (O0)</span><br><span class="line"></span><br><span class="line">  7          42 LOAD_FAST                2 (O0o)</span><br><span class="line">             44 LOAD_FAST                3 (O0)</span><br><span class="line">             46 LOAD_CONST               2 (1)</span><br><span class="line">             48 BINARY_SUBTRACT</span><br><span class="line">             50 BINARY_SUBSCR</span><br><span class="line">             52 LOAD_FAST                2 (O0o)</span><br><span class="line">             54 LOAD_FAST                3 (O0)</span><br><span class="line">             56 BINARY_SUBSCR</span><br><span class="line">             58 BINARY_XOR</span><br><span class="line">             60 STORE_FAST               4 (Oo)</span><br><span class="line"></span><br><span class="line">  8          62 LOAD_FAST                4 (Oo)</span><br><span class="line">             64 LOAD_FAST                2 (O0o)</span><br><span class="line">             66 LOAD_FAST                3 (O0)</span><br><span class="line">             68 STORE_SUBSCR</span><br><span class="line">             70 JUMP_ABSOLUTE           38</span><br><span class="line">        &gt;&gt;   72 POP_BLOCK</span><br><span class="line"></span><br><span class="line">  9     &gt;&gt;   74 LOAD_GLOBAL              3 (bytes)</span><br><span class="line">             76 LOAD_FAST                2 (O0o)</span><br><span class="line">             78 CALL_FUNCTION            1</span><br><span class="line">             80 STORE_FAST               5 (O)</span><br><span class="line"></span><br><span class="line"> 10          82 LOAD_FAST                5 (O)</span><br><span class="line">             84 LOAD_METHOD              4 (hex)</span><br><span class="line">             86 CALL_METHOD              0</span><br><span class="line">             88 RETURN_VALUE</span><br><span class="line"></span><br><span class="line">In [5]: exit()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>输入的flag经过下面字节码的加密后得到<code>&#39;7d037d045717722d62114e6a5b044f2c184c3f44214c2d4a22&#39;</code>，慢慢分析就行，加密源码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span>(<span class="params">OOo</span>):</span></span><br><span class="line">    O0O = OOo[::<span class="number">-1</span>]</span><br><span class="line">    O0o = list(O0O)</span><br><span class="line">    <span class="keyword">for</span> O0 <span class="keyword">in</span> range(<span class="number">1</span>, len(O0o)):</span><br><span class="line">        Oo = O0o[O0<span class="number">-1</span>] ^ O0o[O0]</span><br><span class="line">        O0o[O0] = Oo</span><br><span class="line">    O = bytes(O0o)</span><br><span class="line">    <span class="keyword">return</span> O.hex()</span><br></pre></td></tr></table></figure>

<p>解密函数长这样：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dec</span>(<span class="params">c</span>):</span></span><br><span class="line">    c = list(c)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(c)<span class="number">-1</span>, <span class="number">0</span>, <span class="number">-1</span>):</span><br><span class="line">        c[i] ^= c[i<span class="number">-1</span>]</span><br><span class="line">    <span class="keyword">return</span> bytes(c[::<span class="number">-1</span>])</span><br></pre></td></tr></table></figure>

<h2 id="babypyc"><a href="#babypyc" class="headerlink" title="babypyc"></a>babypyc</h2><p>开头有一个绝对跳转(上面有介绍)，所以uncompyle6反编译不了，但是可以dis+marshal走一波得到可读字节码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br></pre></td><td class="code"><pre><span class="line">  3           0 JUMP_ABSOLUTE            2</span><br><span class="line">        &gt;&gt;    2 LOAD_CONST               0 (0)</span><br><span class="line">              4 LOAD_CONST               1 (None)</span><br><span class="line">              6 IMPORT_NAME              0 (os)</span><br><span class="line">              8 STORE_NAME               0 (os)</span><br><span class="line">             10 LOAD_CONST               0 (0)</span><br><span class="line">             12 LOAD_CONST               1 (None)</span><br><span class="line">             14 IMPORT_NAME              1 (sys)</span><br><span class="line"></span><br><span class="line">  4          16 STORE_NAME               1 (sys)</span><br><span class="line">             18 LOAD_CONST               0 (0)</span><br><span class="line">             20 LOAD_CONST               2 ((&#39;b64encode&#39;,))</span><br><span class="line">             22 IMPORT_NAME              2 (base64)</span><br><span class="line">             24 IMPORT_FROM              3 (b64encode)</span><br><span class="line">             26 STORE_NAME               3 (b64encode)</span><br><span class="line"></span><br><span class="line">  6          28 POP_TOP</span><br><span class="line">             30 LOAD_CONST               3 (b&#39;&#x2F;KDq6pvN&#x2F;LLq6tzM&#x2F;KXq59Oh&#x2F;MTqxtOTxdrqs8OoR3V1X09J&#39;)</span><br><span class="line"></span><br><span class="line">  8          32 STORE_GLOBAL             4 (O0o)</span><br><span class="line">             34 LOAD_CONST               4 (&lt;code object getFlag at 0x0000014E615C0D20, file &quot;task.py&quot;, line 8&gt;)</span><br><span class="line">             36 LOAD_CONST               5 (&#39;getFlag&#39;)</span><br><span class="line">             38 MAKE_FUNCTION            0</span><br><span class="line"></span><br><span class="line"> 16          40 STORE_NAME               5 (getFlag)</span><br><span class="line">             42 LOAD_NAME                5 (getFlag)</span><br><span class="line">             44 CALL_FUNCTION            0</span><br><span class="line"></span><br><span class="line"> 18          46 STORE_NAME               6 (flag)</span><br><span class="line">             48 LOAD_NAME                6 (flag)</span><br><span class="line">             50 LOAD_CONST               1 (None)</span><br><span class="line">             52 LOAD_CONST               6 (6)</span><br><span class="line">             54 BUILD_SLICE              2</span><br><span class="line">             56 BINARY_SUBSCR</span><br><span class="line">             58 LOAD_CONST               7 (b&#39;hgame&#123;&#39;)</span><br><span class="line">             60 COMPARE_OP               3 (!&#x3D;)</span><br><span class="line">             62 POP_JUMP_IF_TRUE        76</span><br><span class="line">             64 LOAD_NAME                6 (flag)</span><br><span class="line">             66 LOAD_CONST               8 (-1)</span><br><span class="line">             68 BINARY_SUBSCR</span><br><span class="line">             70 LOAD_CONST               9 (125)</span><br><span class="line">             72 COMPARE_OP               3 (!&#x3D;)</span><br><span class="line"></span><br><span class="line"> 19          74 POP_JUMP_IF_FALSE       94</span><br><span class="line">        &gt;&gt;   76 LOAD_NAME                7 (print)</span><br><span class="line">             78 LOAD_CONST              10 (&#39;Incorrect format!&#39;)</span><br><span class="line">             80 CALL_FUNCTION            1</span><br><span class="line"></span><br><span class="line"> 20          82 POP_TOP</span><br><span class="line">             84 LOAD_NAME                1 (sys)</span><br><span class="line">             86 LOAD_METHOD              8 (exit)</span><br><span class="line">             88 LOAD_CONST              11 (1)</span><br><span class="line">             90 CALL_METHOD              1</span><br><span class="line"></span><br><span class="line"> 22          92 POP_TOP</span><br><span class="line">        &gt;&gt;   94 LOAD_NAME                6 (flag)</span><br><span class="line">             96 LOAD_CONST               6 (6)</span><br><span class="line">             98 LOAD_CONST               8 (-1)</span><br><span class="line">            100 BUILD_SLICE              2</span><br><span class="line">            102 BINARY_SUBSCR</span><br><span class="line"></span><br><span class="line"> 23         104 STORE_NAME               9 (raw_flag)</span><br><span class="line">            106 LOAD_NAME               10 (len)</span><br><span class="line">            108 LOAD_NAME                6 (flag)</span><br><span class="line">            110 CALL_FUNCTION            1</span><br><span class="line">            112 LOAD_CONST              12 (7)</span><br><span class="line">            114 BINARY_SUBTRACT</span><br><span class="line">            116 LOAD_CONST              13 (36)</span><br><span class="line">            118 COMPARE_OP               3 (!&#x3D;)</span><br><span class="line"></span><br><span class="line"> 24         120 POP_JUMP_IF_FALSE      140</span><br><span class="line">            122 LOAD_NAME                7 (print)</span><br><span class="line">            124 LOAD_CONST              14 (&#39;Wrong length!&#39;)</span><br><span class="line">            126 CALL_FUNCTION            1</span><br><span class="line"></span><br><span class="line"> 25         128 POP_TOP</span><br><span class="line">            130 LOAD_NAME                1 (sys)</span><br><span class="line">            132 LOAD_METHOD              8 (exit)</span><br><span class="line">            134 LOAD_CONST              15 (2)</span><br><span class="line">            136 CALL_METHOD              1</span><br><span class="line"></span><br><span class="line"> 27         138 POP_TOP</span><br><span class="line">        &gt;&gt;  140 LOAD_NAME                9 (raw_flag)</span><br><span class="line">            142 LOAD_CONST               1 (None)</span><br><span class="line">            144 LOAD_CONST               1 (None)</span><br><span class="line">            146 LOAD_CONST               8 (-1)</span><br><span class="line">            148 BUILD_SLICE              3</span><br><span class="line">            150 BINARY_SUBSCR</span><br><span class="line"></span><br><span class="line"> 28         152 STORE_NAME               9 (raw_flag)</span><br><span class="line">            154 LOAD_CONST              16 (&lt;code object &lt;listcomp&gt; at 0x0000014E616835D0, file &quot;task.py&quot;, line 28&gt;)</span><br><span class="line">            156 LOAD_CONST              17 (&#39;&lt;listcomp&gt;&#39;)</span><br><span class="line">            158 MAKE_FUNCTION            0</span><br><span class="line">            160 LOAD_NAME               11 (range)</span><br><span class="line">            162 LOAD_CONST               6 (6)</span><br><span class="line">            164 CALL_FUNCTION            1</span><br><span class="line">            166 GET_ITER</span><br><span class="line">            168 CALL_FUNCTION            1</span><br><span class="line"></span><br><span class="line"> 30         170 STORE_NAME              12 (ciphers)</span><br><span class="line">            172 SETUP_LOOP              86 (to 260)</span><br><span class="line">            174 LOAD_NAME               11 (range)</span><br><span class="line">            176 LOAD_CONST              18 (5)</span><br><span class="line">            178 CALL_FUNCTION            1</span><br><span class="line">            180 GET_ITER</span><br><span class="line">        &gt;&gt;  182 FOR_ITER                74 (to 258)</span><br><span class="line"></span><br><span class="line"> 31         184 STORE_NAME              13 (row)</span><br><span class="line">            186 SETUP_LOOP              68 (to 256)</span><br><span class="line">            188 LOAD_NAME               11 (range)</span><br><span class="line">            190 LOAD_CONST               6 (6)</span><br><span class="line">            192 CALL_FUNCTION            1</span><br><span class="line">            194 GET_ITER</span><br><span class="line">        &gt;&gt;  196 FOR_ITER                56 (to 254)</span><br><span class="line"></span><br><span class="line"> 32         198 STORE_NAME              14 (col)</span><br><span class="line">            200 LOAD_NAME               12 (ciphers)</span><br><span class="line">            202 LOAD_NAME               13 (row)</span><br><span class="line">            204 BINARY_SUBSCR</span><br><span class="line">            206 LOAD_NAME               14 (col)</span><br><span class="line">            208 DUP_TOP_TWO</span><br><span class="line">            210 BINARY_SUBSCR</span><br><span class="line">            212 LOAD_NAME               12 (ciphers)</span><br><span class="line">            214 LOAD_NAME               13 (row)</span><br><span class="line">            216 LOAD_CONST              11 (1)</span><br><span class="line">            218 BINARY_ADD</span><br><span class="line">            220 BINARY_SUBSCR</span><br><span class="line">            222 LOAD_NAME               14 (col)</span><br><span class="line">            224 BINARY_SUBSCR</span><br><span class="line">            226 INPLACE_ADD</span><br><span class="line">            228 ROT_THREE</span><br><span class="line"></span><br><span class="line"> 33         230 STORE_SUBSCR</span><br><span class="line">            232 LOAD_NAME               12 (ciphers)</span><br><span class="line">            234 LOAD_NAME               13 (row)</span><br><span class="line">            236 BINARY_SUBSCR</span><br><span class="line">            238 LOAD_NAME               14 (col)</span><br><span class="line">            240 DUP_TOP_TWO</span><br><span class="line">            242 BINARY_SUBSCR</span><br><span class="line">            244 LOAD_CONST              19 (256)</span><br><span class="line">            246 INPLACE_MODULO</span><br><span class="line">            248 ROT_THREE</span><br><span class="line">            250 STORE_SUBSCR</span><br><span class="line">            252 JUMP_ABSOLUTE          196</span><br><span class="line">        &gt;&gt;  254 POP_BLOCK</span><br><span class="line">        &gt;&gt;  256 JUMP_ABSOLUTE          182</span><br><span class="line"></span><br><span class="line"> 35     &gt;&gt;  258 POP_BLOCK</span><br><span class="line">        &gt;&gt;  260 LOAD_CONST              20 (b&#39;&#39;)</span><br><span class="line"></span><br><span class="line"> 36         262 STORE_NAME              15 (cipher)</span><br><span class="line">            264 SETUP_LOOP              70 (to 336)</span><br><span class="line">            266 LOAD_NAME               11 (range)</span><br><span class="line">            268 LOAD_CONST               6 (6)</span><br><span class="line">            270 CALL_FUNCTION            1</span><br><span class="line">            272 GET_ITER</span><br><span class="line">        &gt;&gt;  274 FOR_ITER                58 (to 334)</span><br><span class="line"></span><br><span class="line"> 37         276 STORE_NAME              13 (row)</span><br><span class="line">            278 LOAD_CONST               0 (0)</span><br><span class="line"></span><br><span class="line"> 38         280 STORE_NAME              14 (col)</span><br><span class="line">            282 SETUP_LOOP              46 (to 330)</span><br><span class="line">        &gt;&gt;  284 LOAD_NAME               14 (col)</span><br><span class="line">            286 LOAD_CONST               6 (6)</span><br><span class="line">            288 COMPARE_OP               0 (&lt;)</span><br><span class="line">            290 EXTENDED_ARG             1</span><br><span class="line"></span><br><span class="line"> 39         292 POP_JUMP_IF_FALSE      328</span><br><span class="line">            294 LOAD_NAME               15 (cipher)</span><br><span class="line">            296 LOAD_NAME               16 (bytes)</span><br><span class="line">            298 LOAD_NAME               12 (ciphers)</span><br><span class="line">            300 LOAD_NAME               13 (row)</span><br><span class="line">            302 BINARY_SUBSCR</span><br><span class="line">            304 LOAD_NAME               14 (col)</span><br><span class="line">            306 BINARY_SUBSCR</span><br><span class="line">            308 BUILD_LIST               1</span><br><span class="line">            310 CALL_FUNCTION            1</span><br><span class="line">            312 INPLACE_ADD</span><br><span class="line"></span><br><span class="line"> 40         314 STORE_NAME              15 (cipher)</span><br><span class="line">            316 LOAD_NAME               14 (col)</span><br><span class="line">            318 LOAD_CONST              11 (1)</span><br><span class="line">            320 INPLACE_ADD</span><br><span class="line">            322 STORE_NAME              14 (col)</span><br><span class="line">            324 EXTENDED_ARG             1</span><br><span class="line">            326 JUMP_ABSOLUTE          284</span><br><span class="line">        &gt;&gt;  328 POP_BLOCK</span><br><span class="line">        &gt;&gt;  330 EXTENDED_ARG             1</span><br><span class="line">            332 JUMP_ABSOLUTE          274</span><br><span class="line"></span><br><span class="line"> 42     &gt;&gt;  334 POP_BLOCK</span><br><span class="line">        &gt;&gt;  336 LOAD_NAME                3 (b64encode)</span><br><span class="line">            338 LOAD_NAME               15 (cipher)</span><br><span class="line">            340 CALL_FUNCTION            1</span><br><span class="line"></span><br><span class="line"> 44         342 STORE_NAME              15 (cipher)</span><br><span class="line">            344 LOAD_NAME               15 (cipher)</span><br><span class="line">            346 LOAD_GLOBAL              4 (O0o)</span><br><span class="line">            348 COMPARE_OP               2 (&#x3D;&#x3D;)</span><br><span class="line">            350 EXTENDED_ARG             1</span><br><span class="line"></span><br><span class="line"> 45         352 POP_JUMP_IF_FALSE      364</span><br><span class="line">            354 LOAD_NAME                7 (print)</span><br><span class="line">            356 LOAD_CONST              21 (&#39;Great, this is my flag.&#39;)</span><br><span class="line">            358 CALL_FUNCTION            1</span><br><span class="line">            360 POP_TOP</span><br><span class="line"></span><br><span class="line"> 47         362 JUMP_FORWARD             8 (to 372)</span><br><span class="line">        &gt;&gt;  364 LOAD_NAME                7 (print)</span><br><span class="line">            366 LOAD_CONST              22 (&#39;Wrong flag.&#39;)</span><br><span class="line">            368 CALL_FUNCTION            1</span><br><span class="line">            370 POP_TOP</span><br><span class="line">        &gt;&gt;  372 LOAD_CONST               1 (None)</span><br><span class="line">            374 RETURN_VALUE</span><br><span class="line"></span><br><span class="line">Disassembly of &lt;code object getFlag at 0x0000014E615C0D20, file &quot;task.py&quot;, line 8&gt;:</span><br><span class="line"> 10           0 LOAD_GLOBAL              0 (print)</span><br><span class="line">              2 LOAD_CONST               1 (&#39;Give me the flag&#39;)</span><br><span class="line">              4 CALL_FUNCTION            1</span><br><span class="line">              6 POP_TOP</span><br><span class="line"></span><br><span class="line"> 11           8 LOAD_GLOBAL              1 (input)</span><br><span class="line">             10 LOAD_CONST               2 (&#39;&gt; &#39;)</span><br><span class="line">             12 CALL_FUNCTION            1</span><br><span class="line">             14 STORE_FAST               0 (flag)</span><br><span class="line"></span><br><span class="line"> 12          16 LOAD_FAST                0 (flag)</span><br><span class="line">             18 LOAD_METHOD              2 (encode)</span><br><span class="line">             20 CALL_METHOD              0</span><br><span class="line">             22 STORE_FAST               0 (flag)</span><br><span class="line"></span><br><span class="line"> 13          24 LOAD_CONST               3 (b&#39;Qre50rOeWr3CsrJ4ccefvNO8n9hclqDNztdbco6pZ3IwRV5Q&#39;)</span><br><span class="line">             26 STORE_GLOBAL             3 (O0o)</span><br><span class="line"></span><br><span class="line"> 14          28 LOAD_FAST                0 (flag)</span><br><span class="line">             30 RETURN_VALUE</span><br><span class="line"></span><br><span class="line">Disassembly of &lt;code object &lt;listcomp&gt; at 0x0000014E616835D0, file &quot;task.py&quot;, line 28&gt;:</span><br><span class="line"> 28           0 BUILD_LIST               0</span><br><span class="line">              2 LOAD_FAST                0 (.0)</span><br><span class="line">        &gt;&gt;    4 FOR_ITER                26 (to 32)</span><br><span class="line">              6 STORE_DEREF              0 (col)</span><br><span class="line">              8 LOAD_CLOSURE             0 (col)</span><br><span class="line">             10 BUILD_TUPLE              1</span><br><span class="line">             12 LOAD_CONST               0 (&lt;code object &lt;listcomp&gt; at 0x0000014E616786F0, file &quot;task.py&quot;, line 28&gt;)</span><br><span class="line">             14 LOAD_CONST               1 (&#39;&lt;listcomp&gt;.&lt;listcomp&gt;&#39;)</span><br><span class="line">             16 MAKE_FUNCTION            8</span><br><span class="line">             18 LOAD_GLOBAL              0 (range)</span><br><span class="line">             20 LOAD_CONST               2 (6)</span><br><span class="line">             22 CALL_FUNCTION            1</span><br><span class="line">             24 GET_ITER</span><br><span class="line">             26 CALL_FUNCTION            1</span><br><span class="line">             28 LIST_APPEND              2</span><br><span class="line">             30 JUMP_ABSOLUTE            4</span><br><span class="line">        &gt;&gt;   32 RETURN_VALUE</span><br><span class="line"></span><br><span class="line">Disassembly of &lt;code object &lt;listcomp&gt; at 0x0000014E616786F0, file &quot;task.py&quot;, line 28&gt;:</span><br><span class="line"> 28           0 BUILD_LIST               0</span><br><span class="line">              2 LOAD_FAST                0 (.0)</span><br><span class="line">        &gt;&gt;    4 FOR_ITER                20 (to 26)</span><br><span class="line">              6 STORE_FAST               1 (row)</span><br><span class="line">              8 LOAD_GLOBAL              0 (raw_flag)</span><br><span class="line">             10 LOAD_CONST               0 (6)</span><br><span class="line">             12 LOAD_FAST                1 (row)</span><br><span class="line">             14 BINARY_MULTIPLY</span><br><span class="line">             16 LOAD_DEREF               0 (col)</span><br><span class="line">             18 BINARY_ADD</span><br><span class="line">             20 BINARY_SUBSCR</span><br><span class="line">             22 LIST_APPEND              2</span><br><span class="line">             24 JUMP_ABSOLUTE            4</span><br><span class="line">        &gt;&gt;   26 RETURN_VALUE</span><br></pre></td></tr></table></figure>

<p>两个嵌套的函数可能有点难度，其他很简单，慢慢分析就行。</p>
<p>官方给的源码长这样：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64encode</span><br><span class="line">O0o = <span class="string">b&#x27;/KDq6pvN/LLq6tzM/KXq59Oh/MTqxtOTxdrqs8OoR3V1X09J&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getFlag</span>():</span></span><br><span class="line">    <span class="keyword">global</span> O0o</span><br><span class="line">    print(<span class="string">&#x27;Give me the flag&#x27;</span>)</span><br><span class="line">    flag = input(<span class="string">&#x27;&gt; &#x27;</span>)</span><br><span class="line">    flag = flag.encode()</span><br><span class="line">    O0o = <span class="string">b&#x27;Qp+ng3SeWoXClJN4cYm3frO8n5rIqL/Nrreuks7JR1JPM19w&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> flag</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">flag = getFlag()</span><br><span class="line"><span class="keyword">if</span> (flag[:<span class="number">6</span>] != <span class="string">b&#x27;hgame&#123;&#x27;</span>) <span class="keyword">or</span> (flag[<span class="number">-1</span>] != <span class="number">125</span>):</span><br><span class="line">    print(<span class="string">&#x27;Incorrect format!&#x27;</span>)</span><br><span class="line">    sys.exit(<span class="number">1</span>)</span><br><span class="line">raw_flag = flag[<span class="number">6</span>:<span class="number">-1</span>]</span><br><span class="line"><span class="keyword">if</span> len(flag) - <span class="number">7</span> != <span class="number">36</span>:</span><br><span class="line">    print(<span class="string">&#x27;Wrong length!&#x27;</span>)</span><br><span class="line">    sys.exit(<span class="number">2</span>)</span><br><span class="line">raw_flag = raw_flag[::<span class="number">-1</span>]</span><br><span class="line">ciphers = [[raw_flag[<span class="number">6</span>*row+col] <span class="keyword">for</span> row <span class="keyword">in</span> range(<span class="number">6</span>)] <span class="keyword">for</span> col <span class="keyword">in</span> range(<span class="number">6</span>)]</span><br><span class="line"><span class="keyword">for</span> row <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">    <span class="keyword">for</span> col <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">        ciphers[row][col] += ciphers[row+<span class="number">1</span>][col]</span><br><span class="line">        ciphers[row][col] %= <span class="number">256</span></span><br><span class="line">cipher = <span class="string">b&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> row <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">    col = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> col &lt; <span class="number">6</span>:</span><br><span class="line">        cipher += bytes([ciphers[row][col]])</span><br><span class="line">        col += <span class="number">1</span></span><br><span class="line">cipher = b64encode(cipher)</span><br><span class="line"><span class="keyword">if</span> cipher == O0o:</span><br><span class="line">    print(<span class="string">&#x27;Great, this is my flag.&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    print(<span class="string">&#x27;Wrong flag.&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我的脚本长这样：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64decode</span><br><span class="line">key = b64decode(<span class="string">b&#x27;Qre50rOeWr3CsrJ4ccefvNO8n9hclqDNztdbco6pZ3IwRV5Q&#x27;</span>)</span><br><span class="line">raw_flag_list = [<span class="number">0</span>]*<span class="number">36</span></span><br><span class="line">raw_flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line">key = [i <span class="keyword">for</span> i <span class="keyword">in</span> key]</span><br><span class="line"><span class="keyword">for</span> row <span class="keyword">in</span> range(<span class="number">5</span>, <span class="number">-1</span>, <span class="number">-1</span>):</span><br><span class="line">    <span class="keyword">for</span> col <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">        <span class="keyword">if</span>(row == <span class="number">5</span>):</span><br><span class="line">            raw_flag_list[row*<span class="number">6</span>+col] = key[row*<span class="number">6</span>+col]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            raw_flag_list[row*<span class="number">6</span>+col] = key[row*<span class="number">6</span>+col] - \</span><br><span class="line">                raw_flag_list[(row+<span class="number">1</span>)*<span class="number">6</span>+col]</span><br><span class="line"><span class="keyword">for</span> col <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">        raw_flag += chr(raw_flag_list[row*<span class="number">6</span>+col])</span><br><span class="line">flag = <span class="string">&#x27;hgame&#123;&#x27;</span>+raw_flag[::<span class="number">-1</span>]+<span class="string">&#x27;&#125;&#x27;</span></span><br><span class="line">print(flag)</span><br><span class="line"><span class="comment">#hgame&#123;PYtH0n^0pcOdE-iS_s0+1nTeresTiNgg89!!&#125;</span></span><br></pre></td></tr></table></figure>


            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls" data-autoplay="true">
                <source type="audio/mpeg" src="">
            </audio>
            
                <ul id="audio-list" style="display:none">
                    
                        
                            <li title='0' data-url='http://music.163.com/song/media/outer/url?id=420154189.mp3'></li>
                        
                    
                        
                            <li title='1' data-url='http://music.163.com/song/media/outer/url?id=527957820.mp3'></li>
                        
                    
                        
                            <li title='2' data-url='http://music.163.com/song/media/outer/url?id=1645064.mp3'></li>
                        
                    
                        
                            <li title='3' data-url='http://music.163.com/song/media/outer/url?id=39635710.mp3'></li>
                        
                    
                        
                            <li title='4' data-url='http://music.163.com/song/media/outer/url?id=464448450.mp3'></li>
                        
                    
                        
                            <li title='5' data-url='http://music.163.com/song/media/outer/url?id=33875750.mp3'></li>
                        
                    
                        
                            <li title='6' data-url='http://music.163.com/song/media/outer/url?id=864711417.mp3'></li>
                        
                    
                </ul>
            
        </div>
        
    <div id='gitalk-container' class="comment link"
		data-enable='true'
        data-ae='true'
        data-ci='b4b7681976b71e1c4b85'
        data-cs='1c0802349efe79789f01f3b548e96a4baf049907'
        data-r='HNightMan.github.io'
        data-o='HNightMan'
        data-a='HNightMan'
        data-d='false'
    >查看评论</div>


    </div>
    
        <div class='side'>
			<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#pyc%E6%96%87%E4%BB%B6%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">pyc文件简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AF%B9%E8%B1%A1"><span class="toc-number">2.</span> <span class="toc-text">代码对象</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#dis%E6%A8%A1%E5%9D%97-%E2%80%94-Python-%E5%AD%97%E8%8A%82%E7%A0%81%E5%8F%8D%E6%B1%87%E7%BC%96%E5%99%A8"><span class="toc-number">3.</span> <span class="toc-text">dis模块 — Python 字节码反汇编器</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#marshal%E6%A8%A1%E5%9D%97-%E2%80%94-%E5%86%85%E9%83%A8-Python-%E5%AF%B9%E8%B1%A1%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">4.</span> <span class="toc-text">marshal模块 — 内部 Python 对象序列化</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#pyc%E6%96%87%E4%BB%B6%E5%88%86%E6%9E%90"><span class="toc-number">5.</span> <span class="toc-text">pyc文件分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Python2-7"><span class="toc-number">5.1.</span> <span class="toc-text">Python2.7</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Python3-7"><span class="toc-number">5.2.</span> <span class="toc-text">Python3.7</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Python%E5%AD%97%E8%8A%82%E7%A0%81%E8%AF%B4%E6%98%8E"><span class="toc-number">6.</span> <span class="toc-text">Python字节码说明</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Python%E5%AD%97%E8%8A%82%E7%A0%81%E6%B7%B7%E6%B7%86"><span class="toc-number">7.</span> <span class="toc-text">Python字节码混淆</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A0%E8%B7%B3%E8%BD%AC-%E5%8F%AF%E5%AF%B9%E6%8A%97uncompyle6"><span class="toc-number">7.1.</span> <span class="toc-text">加跳转(可对抗uncompyle6)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A0%E8%B7%B3%E8%BD%AC%E5%92%8C%E9%94%99%E8%AF%AF%E8%AF%AD%E5%8F%A5-%E5%8F%AF%E5%AF%B9%E6%8A%97dis%E5%92%8Cuncompyle6"><span class="toc-number">7.2.</span> <span class="toc-text">加跳转和错误语句(可对抗dis和uncompyle6)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%87%8D%E5%8F%A0%E6%8C%87%E4%BB%A4-%E5%8F%AF%E4%BB%A5%E5%AF%B9%E6%8A%97dis%E5%92%8Cuncompyle6"><span class="toc-number">7.3.</span> <span class="toc-text">重叠指令(可以对抗dis和uncompyle6)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A7%81%E6%9C%89%E6%8C%87%E4%BB%A4%E9%9B%86"><span class="toc-number">7.4.</span> <span class="toc-text">私有指令集</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Python%E5%AD%97%E8%8A%82%E7%A0%81%E5%8F%8D%E6%B7%B7%E6%B7%86"><span class="toc-number">8.</span> <span class="toc-text">Python字节码反混淆</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%A2%98%E8%A7%A3"><span class="toc-number">9.</span> <span class="toc-text">题解</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#babypy"><span class="toc-number">9.1.</span> <span class="toc-text">babypy</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#babypyc"><span class="toc-number">9.2.</span> <span class="toc-text">babypyc</span></a></li></ol></li></ol>	
        </div>
    
</div>


    </div>
</div>
</body>

<script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>


<script src="//lib.baomitu.com/jquery/1.8.3/jquery.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/typed.js"></script>
<script src="/js/diaspora.js"></script>


<link rel="stylesheet" href="/photoswipe/photoswipe.css">
<link rel="stylesheet" href="/photoswipe/default-skin/default-skin.css">


<script src="/photoswipe/photoswipe.min.js"></script>
<script src="/photoswipe/photoswipe-ui-default.min.js"></script>


<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>






</html>
